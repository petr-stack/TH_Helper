<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="./manifest.json">
<script>
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(console.warn);
}
</script>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Shop Helper — v0.19.0</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Inter:wght@400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /* ── Design tokens ─────────────────────────────────────────────── */
  :root{
    --bg:#0b1117;
    --surface:#0f1620;
    --card:#111b26;
    --ink:#e7ecf2;
    --muted:#94a3b8;
    --line:#1f2b38;
    --accent:#f5b146;
    --accent-2:#22d3ee;
    --accent-3:#34d399;
    --accent-4:#f87171;
    --radius:14px;
    --shadow:0 12px 30px rgba(0,0,0,.35);
    --ok:#34d399; --warn:#f59e0b; --bad:#ef4444;
    --mono:'DM Mono',monospace;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:Inter,system-ui,sans-serif;
    color:var(--ink);
    background:
      radial-gradient(800px 500px at 80% -10%, rgba(34,211,238,.07), transparent 60%),
      radial-gradient(1000px 600px at -10% 20%, rgba(245,177,70,.07), transparent 60%),
      linear-gradient(180deg,#0a0f15,#0b1117 40%,#0b1117);
    min-height:100vh;
  }

  /* ── Sticky header ──────────────────────────────────────────────── */
  header{
    position:sticky;top:0;z-index:20;
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--bg);
    backdrop-filter:saturate(120%) blur(6px);
    border-bottom:1px solid var(--line);
  }
  .header-inner{
    max-width:1280px;margin:0 auto;
    display:flex;align-items:center;gap:12px;
    padding:10px 20px;
  }
  .brand-logo{height:26px;display:block;object-fit:contain;filter:invert(1) brightness(1.6)}
  .brand-name{
    font-family:Montserrat,sans-serif;font-weight:800;
    font-size:17px;letter-spacing:.08em;text-transform:uppercase;
  }
  .tag{
    border:1px solid var(--line);border-radius:999px;
    padding:3px 10px;font-size:11px;color:var(--muted);
  }
  .tag--amber{border-color:rgba(245,177,70,.4);color:#ffd9a2}
  .header-tagline{margin-left:auto;font-size:11.5px;color:var(--muted);font-style:italic}

  /* ── Tab bar ────────────────────────────────────────────────────── */
  .tabbar{
    max-width:1280px;margin:0 auto;
    display:flex;align-items:end;gap:2px;
    padding:0 20px;
    border-bottom:1px solid var(--line);
  }
  .tab{
    padding:9px 18px 10px;
    font-size:12px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;
    color:var(--muted);cursor:pointer;border:none;background:none;
    border-bottom:2px solid transparent;
    transition:color .15s,border-color .15s;
    white-space:nowrap;
  }
  .tab:hover{color:var(--ink)}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .tab-icon{margin-right:6px;font-size:13px}

  /* ── Page wrapper ───────────────────────────────────────────────── */
  .wrap{max-width:1280px;margin:0 auto;padding:24px 20px 56px}

  /* ── Tab panels ─────────────────────────────────────────────────── */
  .tabpanel{display:none}
  .tabpanel.active{display:block}

  /* ── Main tool grid (Materials + Fasteners + DB) ────────────────── */
  .tool-grid{display:grid;grid-template-columns:1fr 1fr 0.75fr;gap:16px}
  @media(max-width:1100px){.tool-grid{grid-template-columns:1fr 1fr}}
  @media(max-width:720px){.tool-grid{grid-template-columns:1fr}}

  /* ── Panels ─────────────────────────────────────────────────────── */
  .panel{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--surface);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
  }
  .panel-title{
    margin:0 0 12px;
    font-family:Montserrat,sans-serif;font-weight:700;
    letter-spacing:.06em;text-transform:uppercase;font-size:13px;color:#dbe3ec;
    display:flex;align-items:center;gap:8px;
  }
  .panel-title-icon{font-size:15px;opacity:.8}

  /* ── Cards (nested) ─────────────────────────────────────────────── */
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04)),var(--card);
    border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px;
  }
  .card h3{margin:0 0 8px;font-size:11.5px;font-family:Montserrat,sans-serif;
    letter-spacing:.06em;text-transform:uppercase;color:#dbe3ec}

  /* ── Form elements ──────────────────────────────────────────────── */
  label{display:block;font-size:11.5px;color:var(--muted);margin-bottom:5px;letter-spacing:.02em}
  input,select,textarea,button{
    width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
    background:#0b141d;color:var(--ink);outline:none;font-size:14px;
    transition:border-color .15s,box-shadow .15s,transform .05s;
    font-family:inherit;
  }
  input:focus,select:focus{border-color:#26384d;box-shadow:0 0 0 3px rgba(34,211,238,.12)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row>div{flex:1;min-width:200px}
  button{
    width:auto;
    background:linear-gradient(180deg,rgba(245,177,70,.22),rgba(245,177,70,.12));
    border:1px solid rgba(245,177,70,.45);
    color:#ffdfb0;font-weight:600;letter-spacing:.02em;cursor:pointer;
  }
  button:hover{border-color:#ffc978;background:linear-gradient(180deg,rgba(245,177,70,.32),rgba(245,177,70,.18))}
  button:active{transform:translateY(1px)}

  /* ── Output box ─────────────────────────────────────────────────── */
  .tips{
    background:linear-gradient(180deg,rgba(34,211,238,.05),rgba(245,177,70,.05));
    border:1px dashed #273448;border-radius:12px;padding:10px 12px;
    white-space:pre-wrap;color:#dbe3ec;font-size:13px;line-height:1.6;
    font-family:var(--mono);
  }

  .pill{display:inline-block;border:1px solid #2a3b4f;border-radius:999px;padding:2px 9px;font-size:11.5px;margin-right:5px}
  .small{font-size:12px;color:var(--muted)}
  .separator{height:1px;background:linear-gradient(90deg,transparent,#1b2735 20%,#1b2735 80%,transparent);margin:12px 0}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

  /* ── Dropzone ───────────────────────────────────────────────────── */
  .dropzone{
    display:flex;align-items:center;justify-content:center;text-align:center;
    padding:20px;border:1px dashed #2a3b4f;border-radius:12px;cursor:pointer;
    background:linear-gradient(180deg,rgba(34,211,238,.04),rgba(245,177,70,.04));
    color:#dbe3ec;min-height:96px;
    transition:border-color .15s,background .15s,box-shadow .2s;
  }
  .dropzone.drag{border-color:#ffd9a2;background:linear-gradient(180deg,rgba(245,177,70,.10),rgba(34,211,238,.06))}
  .dropzone.ok-flash{box-shadow:0 0 0 3px rgba(52,211,153,.25)}

  /* ════════════════════════════════════════════════════════════════
     DYTAT CHECKLIST TAB
  ════════════════════════════════════════════════════════════════ */

  /* Progress bar */
  .dytat-progress-wrap{
    background:var(--surface);border:1px solid var(--line);border-radius:12px;
    padding:14px 18px;margin-bottom:18px;
    display:flex;align-items:center;gap:16px;
  }
  .progress-bar-track{
    flex:1;height:8px;background:var(--line);border-radius:999px;overflow:hidden;
  }
  .progress-bar-fill{
    height:100%;border-radius:999px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));
    transition:width .35s cubic-bezier(.4,0,.2,1);
    width:0%;
  }
  .progress-label{font-size:12px;color:var(--muted);white-space:nowrap;font-family:var(--mono)}
  .progress-label strong{color:var(--accent)}

  .dytat-callout{
    background:rgba(245,177,70,.07);border:1px solid rgba(245,177,70,.25);
    border-left:3px solid var(--accent);border-radius:10px;
    padding:10px 14px;margin-bottom:18px;
    font-size:12.5px;color:#ffd9a2;font-weight:500;
  }

  /* Category grid */
  .dytat-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:14px;
    margin-bottom:14px;
  }
  .dytat-grid-2{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:14px;
    margin-bottom:14px;
  }
  .dytat-grid-wide{
    display:grid;
    grid-template-columns:1.15fr 1fr 1fr;
    gap:14px;
    margin-bottom:14px;
  }
  @media(max-width:900px){
    .dytat-grid,.dytat-grid-2,.dytat-grid-wide{grid-template-columns:1fr 1fr}
  }
  @media(max-width:600px){
    .dytat-grid,.dytat-grid-2,.dytat-grid-wide{grid-template-columns:1fr}
  }

  /* Category card */
  .cat-card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--surface);
    border:1px solid var(--line);border-radius:var(--radius);
    padding:14px;position:relative;overflow:hidden;
  }
  .cat-card::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:var(--cat-color,var(--accent));
  }
  .cat-title{
    font-family:Montserrat,sans-serif;font-weight:700;font-size:12.5px;
    letter-spacing:.06em;text-transform:uppercase;
    color:#dbe3ec;margin:0 0 10px;
    display:flex;align-items:center;gap:8px;
  }
  .cat-num{margin-left:auto;font-family:var(--mono);font-size:10px;color:var(--cat-color,var(--accent));opacity:.7}

  /* Sub-labels within a card */
  .sub-lbl{
    font-size:10px;letter-spacing:.12em;text-transform:uppercase;
    color:#3a4f65;font-family:var(--mono);font-weight:500;
    margin:8px 0 5px;
  }
  .cat-divider{height:1px;background:var(--line);margin:8px 0}

  /* Checklist items */
  .checklist{list-style:none;display:flex;flex-direction:column;gap:4px;margin:0;padding:0}
  .check-item{display:flex;align-items:flex-start;gap:9px;padding:3px 0}
  .check-item label{
    display:flex;align-items:flex-start;gap:9px;
    cursor:pointer;font-size:12px;color:var(--ink);font-weight:400;
    line-height:1.5;margin:0;letter-spacing:0;
    flex:1;
  }
  .check-item input[type=checkbox]{
    width:14px;height:14px;min-width:14px;
    border-radius:3px;border:1.5px solid #3a4f65;
    background:transparent;cursor:pointer;
    padding:0;margin-top:1px;flex-shrink:0;
    accent-color:var(--accent);
    transition:border-color .15s;
  }
  .check-item input[type=checkbox]:checked + span{
    color:var(--muted);text-decoration:line-through;text-decoration-color:rgba(148,163,184,.4);
  }
  .check-item input[type=checkbox]:checked{border-color:var(--accent)}
  .check-item span strong{color:#ffd9a2;font-weight:600}
  .check-item span .note{
    color:var(--muted);font-size:10.5px;display:block;margin-top:1px;font-style:italic;
  }
  .check-item.done label{opacity:.55}

  /* Bottom banner (5-col strip) */
  .dytat-banner{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent),var(--surface);
    border:1px solid var(--line);border-radius:var(--radius);
    padding:14px 18px;
    display:grid;grid-template-columns:repeat(5,1fr);gap:0;
    margin-bottom:14px;position:relative;overflow:hidden;
  }
  .dytat-banner::before{
    content:'';position:absolute;top:0;left:0;right:0;height:3px;
    background:linear-gradient(90deg,var(--accent),var(--accent-2),var(--accent-3),var(--accent-4),var(--accent));
  }
  @media(max-width:900px){.dytat-banner{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:600px){.dytat-banner{grid-template-columns:1fr 1fr}}
  .banner-col{padding:0 14px;border-right:1px solid var(--line)}
  .banner-col:first-child{padding-left:0}
  .banner-col:last-child{border-right:none}
  .banner-lbl{
    font-size:10px;letter-spacing:.12em;text-transform:uppercase;
    color:var(--muted);font-family:var(--mono);font-weight:500;margin-bottom:8px;
  }
  .banner-col .checklist{gap:3px}
  .banner-col .check-item label{font-size:11px}

  /* Reset + export strip */
  .dytat-controls{
    display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;
  }
  .dytat-controls button{padding:8px 16px;font-size:12px}
  .btn-ghost{
    background:transparent!important;
    border-color:var(--line)!important;
    color:var(--muted)!important;
  }
  /* ── FDM 3D Print tab ──────────────────────────────────────────────── */
  .fdm-fit-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px}
  @media(max-width:900px){.fdm-fit-grid{grid-template-columns:1fr 1fr}}
  @media(max-width:600px){.fdm-fit-grid{grid-template-columns:1fr}}
  .fdm-fit-card{
    background:var(--card);border:1px solid var(--line);border-radius:10px;
    padding:10px 12px;cursor:pointer;transition:border-color .15s,background .15s;
  }
  .fdm-fit-card:hover,.fdm-fit-card.selected{
    border-color:rgba(245,177,70,.5);
    background:linear-gradient(180deg,rgba(245,177,70,.08),rgba(0,0,0,.04)),var(--card);
  }
  .fdm-fit-card .ffc-label{font-size:11px;font-family:Montserrat,sans-serif;letter-spacing:.06em;text-transform:uppercase;color:#dbe3ec;margin-bottom:3px}
  .fdm-fit-card .ffc-val{font-size:20px;font-weight:700;font-family:var(--mono);color:var(--accent)}
  .fdm-fit-card .ffc-use{font-size:11px;color:var(--muted);margin-top:4px;line-height:1.4}

  .fdm-rule{border:1px solid var(--line);border-radius:10px;margin-bottom:6px;overflow:hidden}
  .fdm-rule-hdr{
    display:flex;align-items:center;gap:8px;padding:10px 12px;cursor:pointer;
    background:linear-gradient(180deg,rgba(255,255,255,.015),transparent),var(--surface);
    transition:background .12s;
  }
  .fdm-rule-hdr:hover{background:linear-gradient(180deg,rgba(245,177,70,.06),transparent),var(--surface)}
  .fdm-rule-icon{font-size:16px;color:var(--accent);min-width:20px;text-align:center}
  .fdm-rule-title{font-family:Montserrat,sans-serif;font-weight:700;font-size:12px;letter-spacing:.06em;text-transform:uppercase;flex:1}
  .fdm-rule-chevron{color:var(--muted);font-size:12px;transition:transform .15s}
  .fdm-rule-body{display:none;padding:0 12px 12px;background:rgba(0,0,0,.12)}
  .fdm-rule-body.open{display:block}
  .fdm-rule-vals{display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;margin-bottom:8px}
  .fdm-rule-vals dt{font-size:11px;color:var(--muted)}
  .fdm-rule-vals dd{font-size:11px;color:var(--accent);font-family:var(--mono);font-weight:600;margin:0}

  .fdm-mat-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:6px}
  .fdm-mat-table th{text-align:left;padding:5px 8px;color:var(--muted);font-family:Montserrat,sans-serif;letter-spacing:.05em;text-transform:uppercase;border-bottom:1px solid var(--line);font-size:10px}
  .fdm-mat-table td{padding:6px 8px;border-bottom:1px solid rgba(31,43,56,.5);vertical-align:top;line-height:1.4}
  .fdm-mat-table tr:last-child td{border-bottom:none}
  .fdm-mat-table tr:hover td{background:rgba(245,177,70,.04)}
  .fdm-mat-name{font-weight:600;color:#dbe3ec;white-space:nowrap}
  .badge{display:inline-block;padding:1px 6px;border-radius:999px;font-size:10px;border:1px solid}
  .badge-ok{color:#34d399;border-color:rgba(52,211,153,.3);background:rgba(52,211,153,.08)}
  .badge-warn{color:#f59e0b;border-color:rgba(245,158,11,.3);background:rgba(245,158,11,.08)}
  .badge-bad{color:#ef4444;border-color:rgba(239,68,68,.3);background:rgba(239,68,68,.08)}

  .fdm-tip-list{list-style:none;padding:0;margin:0}
  .fdm-tip-list li{
    padding:8px 10px;border-bottom:1px solid rgba(31,43,56,.6);font-size:12px;
    display:flex;gap:8px;align-items:flex-start;line-height:1.5;
  }
  .fdm-tip-list li:last-child{border-bottom:none}
  .fdm-tip-cat{
    font-size:9px;font-family:Montserrat,sans-serif;letter-spacing:.06em;text-transform:uppercase;
    padding:2px 6px;border-radius:999px;border:1px solid var(--line);color:var(--muted);
    white-space:nowrap;align-self:flex-start;margin-top:1px;min-width:60px;text-align:center;
  }
  .fdm-tip-filter{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .fdm-tip-filter button{
    padding:4px 10px;font-size:11px;border-radius:999px;
    background:transparent;border-color:var(--line);color:var(--muted);
    width:auto;
  }
  .fdm-tip-filter button.active{border-color:rgba(245,177,70,.5);color:#ffdfb0;background:rgba(245,177,70,.1)}

  .fdm-calc-result{
    background:linear-gradient(180deg,rgba(34,211,238,.06),rgba(245,177,70,.04));
    border:1px solid #273448;border-radius:12px;padding:14px;margin-top:10px;
    font-size:13px;line-height:1.7;
  }
  .fdm-big{font-size:26px;font-weight:700;font-family:var(--mono);color:var(--accent)}


  .cnc-result-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px}
  .cnc-stat{
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.06)),var(--card);
    border:1px solid var(--line);border-radius:10px;padding:10px 8px;text-align:center;
  }
  .cnc-stat-label{font-size:10px;color:var(--muted);font-family:Montserrat,sans-serif;letter-spacing:.06em;text-transform:uppercase;margin-bottom:4px}
  .cnc-stat-value{font-size:22px;font-weight:700;font-family:var(--mono);color:var(--accent);line-height:1}
  .cnc-stat-sub{font-size:10px;color:var(--muted);margin-top:3px}


  .ins-tab{
    background:rgba(255,255,255,.03);border:1px solid var(--line);
    border-radius:8px;color:var(--muted);cursor:pointer;
    transition:border-color .15s,color .15s,background .15s;
  }
  .ins-tab:hover{border-color:var(--accent);color:var(--accent)}
  .ins-tab-active{
    background:linear-gradient(180deg,rgba(245,177,70,.18),rgba(245,177,70,.08));
    border-color:rgba(245,177,70,.5)!important;color:#ffdfb0!important;
  }

</style>
</head>
<body>

<!-- ══ HEADER ════════════════════════════════════════════════════════════ -->
<header>
  <div class="header-inner">
    <img id="thLogo" class="brand-logo" alt="TruckHouse">
    <span class="brand-name">Shop Helper</span>
    <span class="tag">v0.19.0</span>
    <span class="tag tag--amber">DB: drag &amp; drop</span>
    <span class="header-tagline">Clean holes, happy souls.</span>
  </div>

  <!-- Tab bar -->
  <nav class="tabbar" role="tablist">
    <button class="tab active" role="tab" data-tab="tools" aria-selected="true">
      <span class="tab-icon">⚙</span>Tools
    </button>
    <button class="tab" role="tab" data-tab="sheetmetal" aria-selected="false">
      <span class="tab-icon">◧</span>Sheet Metal
    </button>
    <button class="tab" role="tab" data-tab="fdm" aria-selected="false">
      <span class="tab-icon">⬡</span>3D Print Fits
    </button>
    <button class="tab" role="tab" data-tab="cnc" aria-selected="false">
      <span class="tab-icon">⌁</span>CNC Router
    </button>
    <button class="tab" role="tab" data-tab="dytat" aria-selected="false">
      <span class="tab-icon">✓</span>DYTAT Checklist
    </button>
  </nav>
</header>

<!-- ══ TOOLS TAB ═════════════════════════════════════════════════════════ -->
<div id="tab-tools" class="tabpanel active" role="tabpanel">
  <div class="wrap">
    <div class="tool-grid">

      <!-- MATERIALS -->
      <section class="panel">
        <h2 class="panel-title"><span class="panel-title-icon">◈</span> Material Playbook</h2>
        <div class="row">
          <div>
            <label>Material</label>
            <input id="matInput" list="matList" placeholder="e.g., 6061, 300 stainless, richlite">
            <datalist id="matList"></datalist>
          </div>
          <div style="align-self:flex-end">
            <button id="matGo">Show</button>
          </div>
        </div>
        <div id="matSummary" class="tips" style="margin-top:10px;display:none"></div>
        <div id="matDetails" class="tips" style="margin-top:10px;display:none"></div>

        <div class="card">
          <h3>Hole Saw Helper</h3>
          <div class="row">
            <div><label>Diameter</label><input id="hsDia" type="number" step="0.01" placeholder="2.50"></div>
            <div><label>Units</label>
              <select id="hsUnits">
                <option value="in">in</option>
                <option value="mm">mm</option>
              </select>
            </div>
          </div>
          <button id="hsCalc" style="margin-top:8px">Calc RPM</button>
          <div id="hsOut" class="tips" style="margin-top:10px;display:none"></div>
        </div>
      </section>

      <!-- FASTENERS -->
      <section class="panel">
        <h2 class="panel-title"><span class="panel-title-icon">⬡</span> Fastener Calculator</h2>
        <div class="row">
          <div>
            <label>Kind</label>
            <select id="kind">
              <option value="machine">Machine (tap &amp; clearance)</option>
              <option value="sheetmetal">Sheet metal (pilot)</option>
              <option value="wood">Wood screw (pilot)</option>
            </select>
          </div>
          <div>
            <label>Size</label>
            <input id="fz" list="fzList" placeholder="#8-32, 1/4-20, M6x1.0">
            <datalist id="fzList"></datalist>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Clearance fit</label>
            <select id="fit">
              <option value="close">Close</option>
              <option value="standard" selected>Standard</option>
              <option value="loose">Loose</option>
            </select>
          </div>
          <div style="align-self:flex-end;padding-bottom:2px">
            <label class="small" style="display:flex;align-items:center;gap:6px;cursor:pointer">
              <input type="checkbox" id="sti" style="width:14px;height:14px;accent-color:var(--accent)"> STI / Helicoil
            </label>
          </div>
        </div>
        <button id="calc" style="margin-top:10px">Calculate</button>
        <div id="fzOut" class="tips" style="margin-top:10px;display:none"></div>
      </section>

      <!-- INSERTS (PEM + Heat-Set) -->
      <section class="panel">
        <h2 class="panel-title"><span class="panel-title-icon">⬢</span> Insert Hole Calculator</h2>

        <!-- Sub-tabs -->
        <div style="display:flex;gap:6px;margin-bottom:12px">
          <button id="insTabPem"  class="ins-tab ins-tab-active" style="flex:1;font-size:11px;padding:6px 4px">PEM (Sheet Metal)</button>
          <button id="insTabHs"   class="ins-tab" style="flex:1;font-size:11px;padding:6px 4px">Heat-Set (3DP)</button>
        </div>

        <!-- ── PEM PANEL ── -->
        <div id="insPemPanel">
          <div class="row">
            <div>
              <label>Type</label>
              <select id="pemType">
                <option value="nuts">Self-Clinching Nut (S/SS/SO)</option>
                <option value="flushStuds">Flush Stud (FH/FHS/FHM)</option>
              </select>
            </div>
            <div>
              <label>Thread Size</label>
              <select id="pemSize"></select>
            </div>
          </div>
          <button id="pemCalc" style="margin-top:8px">Look up hole</button>
          <div id="pemOut" class="tips" style="margin-top:10px;display:none"></div>
          <div class="separator"></div>
          <div class="small" style="color:var(--muted);white-space:pre-wrap" id="pemNotes"></div>
        </div>

        <!-- ── HEAT-SET PANEL ── -->
        <div id="insHsPanel" style="display:none">
          <div class="row">
            <div>
              <label>Thread Size</label>
              <select id="hsInsSize"></select>
            </div>
            <div>
              <label>Print Material</label>
              <select id="hsInsMat">
                <option value="PLA">PLA</option>
                <option value="PETG" selected>PETG</option>
                <option value="ABS">ABS</option>
                <option value="ASA">ASA</option>
                <option value="PA/Nylon">PA / Nylon</option>
                <option value="PC">PC</option>
              </select>
            </div>
          </div>
          <button id="hsInsCalc" style="margin-top:8px">Look up hole</button>
          <div id="hsInsOut" class="tips" style="margin-top:10px;display:none"></div>
          <div class="separator"></div>
          <div class="small" style="color:var(--muted);white-space:pre-wrap" id="hsInsNotes"></div>
        </div>
      </section>

      <!-- DATABASE -->
      <section class="panel">
        <h2 class="panel-title"><span class="panel-title-icon">⬣</span> Database</h2>
        <div id="drop" class="dropzone" role="button" tabindex="0"
             aria-label="Drop shopdb.json here or click to choose">
          <div>
            <div style="font-weight:600;letter-spacing:.02em">Drop <code>shopdb.json</code> here</div>
            <div class="small" style="margin-top:4px">…or click to choose a file</div>
          </div>
        </div>
        <input id="file" type="file" accept=".json,application/json" style="display:none">

        <div class="row" style="margin-top:10px">
          <button id="exportDb">Export DB</button>
          <button id="clearDb" class="btn-ghost" style="
            background:transparent;border-color:var(--line);color:var(--muted)">Clear cache</button>
        </div>
        <div class="separator"></div>
        <div id="dbStatus" class="small"></div>
      </section>

    </div><!-- /tool-grid -->
  </div><!-- /wrap -->
</div><!-- /tab-tools -->


<!-- ══ DYTAT TAB ══════════════════════════════════════════════════════════ -->
<!-- ══ FDM 3D PRINT FITS & DESIGN TAB ══════════════════════════════════ -->
<div id="tab-fdm" class="tabpanel" role="tabpanel">
<div class="wrap">

  <!-- ROW 1: Fit Calculator + Hole Compensation -->
  <div class="tool-grid" style="grid-template-columns:1.4fr 1fr;gap:16px;align-items:start">

    <!-- FIT CALCULATOR -->
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">⬡</span> Fit Calculator</h2>
      <div class="row">
        <div>
          <label>Nominal diameter / dimension</label>
          <input id="fdmDia" type="number" step="0.1" min="0.5" placeholder="10.0" value="10.0">
        </div>
        <div>
          <label>Units</label>
          <select id="fdmUnits">
            <option value="mm" selected>mm</option>
            <option value="in">in</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Fit type — click to select</label>
        <div class="fdm-fit-grid" id="fdmFitGrid"><!-- populated by JS --></div>
      </div>
      <div id="fdmCalcResult" style="display:none" class="fdm-calc-result">
        <div style="margin-bottom:6px;font-size:11px;color:var(--muted);text-transform:uppercase;font-family:Montserrat,sans-serif;letter-spacing:.06em" id="fdmResLabel"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center">
          <div>
            <div style="font-size:10px;color:var(--muted);margin-bottom:2px">SHAFT / PIN</div>
            <div class="fdm-big" id="fdmResShaft">—</div>
            <div style="font-size:10px;color:var(--muted)" id="fdmResShaftSub"></div>
          </div>
          <div style="display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:20px">⟷</div>
          <div>
            <div style="font-size:10px;color:var(--muted);margin-bottom:2px">BORE / HOLE</div>
            <div class="fdm-big" id="fdmResBore">—</div>
            <div style="font-size:10px;color:var(--muted)" id="fdmResboreSub"></div>
          </div>
        </div>
        <div class="separator"></div>
        <div style="font-size:11px;color:var(--muted)" id="fdmResUse"></div>
        <div style="font-size:10px;color:#64748b;margin-top:4px;font-family:monospace" id="fdmResFormula"></div>
        <div style="font-size:11px;color:#f59e0b;margin-top:6px" id="fdmResWarn"></div>
      </div>
    </section>

    <!-- HOLE COMPENSATION -->
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">○</span> Hole Compensation</h2>
      <div class="tips" style="font-size:12px;white-space:pre-wrap;margin-bottom:10px">FDM holes always print <strong style="color:var(--accent)">undersized</strong>. STL tessellation + bead width reduce every hole.

Vertical hole (axis = Z):
  Add <strong style="color:var(--accent)">+0.2 mm</strong> to nominal Ø in CAD

Horizontal hole (axis = XY):
  Add <strong style="color:var(--accent)">+0.3–0.5 mm</strong> to nominal Ø in CAD

Best practice:
  Model slightly oversize → ream to
  final Ø with a drill bit.
  Fastest path to a precise fit.</div>
      <div class="separator"></div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Elephant Foot — Bottom Edge</div>
      <div class="tips" style="font-size:12px">First layer squish flares bottom edges outward 0.1–0.5 mm. Fix: add a <strong style="color:var(--accent)">0.3–0.5 mm × 45° chamfer</strong> to the bottom edge of any precision feature in CAD.</div>
      <div class="separator"></div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Minimum Modeled Thread</div>
      <div class="tips" style="font-size:12px">Don't model threads smaller than <strong style="color:var(--accent)">M5 / #10</strong>. Smaller = stripped immediately. Use heat-set inserts → see Insert Hole Calculator tab.</div>
    </section>

  </div><!-- /row1 -->

  <!-- ROW 2: Design Rules accordion (full width) -->
  <div style="margin-top:16px">
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">◈</span> Design Rules — click to expand</h2>
      <div id="fdmRulesAccordion" style="margin-top:6px"><!-- populated by JS --></div>
    </section>
  </div>

  <!-- ROW 3: Material quick-ref + Tips library -->
  <div class="tool-grid" style="grid-template-columns:1.2fr 1fr;gap:16px;margin-top:16px;align-items:start">

    <!-- MATERIAL QUICK REF -->
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">◎</span> Material Quick Reference</h2>
      <div id="fdmMatTable"><!-- populated by JS --></div>
    </section>

    <!-- SHOP TIPS -->
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">★</span> Shop Tips</h2>
      <div class="fdm-tip-filter" id="fdmTipFilter"><!-- populated by JS --></div>
      <ul class="fdm-tip-list" id="fdmTipList"><!-- populated by JS --></ul>
    </section>

  </div>

</div><!-- /wrap -->
</div><!-- /tab-fdm -->

<!-- ══ CNC ROUTER TAB ════════════════════════════════════════════════ -->

<div id="tab-cnc" class="tabpanel" role="tabpanel">
<div class="wrap">

  <div class="tool-grid" style="grid-template-columns:1fr 1fr 1fr;align-items:start">

    <!-- INPUTS PANEL -->
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">⌁</span> CNC Router — Feeds &amp; Speeds</h2>

      <div class="row">
        <div>
          <label>Material</label>
          <select id="cncMat"></select>
        </div>
        <div>
          <label>Bit Type</label>
          <select id="cncBit"></select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Bit Diameter</label>
          <input id="cncDia" type="number" step="0.0625" min="0.0625" max="2" placeholder="0.25" value="0.25">
        </div>
        <div>
          <label>Units</label>
          <select id="cncDiaUnits">
            <option value="in">in</option>
            <option value="mm">mm</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Spindle RPM</label>
          <input id="cncRpm" type="number" step="500" min="1000" max="30000" placeholder="18000" value="18000">
        </div>
        <div>
          <label>Chipload bias</label>
          <select id="cncBias">
            <option value="lo">Conservative (new bit / first cut)</option>
            <option value="mid" selected>Mid (typical)</option>
            <option value="hi">Aggressive (proven setup)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>Cut type</label>
          <select id="cncCutType">
            <option value="rough" selected>Roughing</option>
            <option value="finish">Finishing</option>
          </select>
        </div>
        <div>
          <label>Material thickness</label>
          <input id="cncThk" type="number" step="0.01" min="0.01" placeholder="0.50" value="0.50">
          <span class="small" style="color:var(--muted)">same units as dia</span>
        </div>
      </div>

      <button id="cncCalc" style="margin-top:12px;width:100%">Calculate</button>
    </section>

    <!-- RESULTS PANEL -->
    <section class="panel" id="cncResultPanel">
      <h2 class="panel-title"><span class="panel-title-icon">◈</span> Results</h2>
      <div id="cncOut" style="display:none">

        <div class="cnc-result-grid">
          <div class="cnc-stat">
            <div class="cnc-stat-label">Chipload</div>
            <div class="cnc-stat-value" id="cncResChipload">—</div>
            <div class="cnc-stat-sub" id="cncResChiploadsub"></div>
          </div>
          <div class="cnc-stat">
            <div class="cnc-stat-label">Feed Rate</div>
            <div class="cnc-stat-value" id="cncResFeed">—</div>
            <div class="cnc-stat-sub">in/min (IPM)</div>
          </div>
          <div class="cnc-stat">
            <div class="cnc-stat-label">Plunge Rate</div>
            <div class="cnc-stat-value" id="cncResPlunge">—</div>
            <div class="cnc-stat-sub">in/min</div>
          </div>
          <div class="cnc-stat">
            <div class="cnc-stat-label">Depth of Cut</div>
            <div class="cnc-stat-value" id="cncResDoc">—</div>
            <div class="cnc-stat-sub" id="cncResDocsub"></div>
          </div>
          <div class="cnc-stat">
            <div class="cnc-stat-label">Stepover</div>
            <div class="cnc-stat-value" id="cncResSo">—</div>
            <div class="cnc-stat-sub" id="cncResSosub"></div>
          </div>
          <div class="cnc-stat">
            <div class="cnc-stat-label">SFM</div>
            <div class="cnc-stat-value" id="cncResSfm">—</div>
            <div class="cnc-stat-sub" id="cncResSfmsub"></div>
          </div>
        </div>

        <div class="separator"></div>

        <div style="font-size:12px;color:var(--muted);margin-bottom:6px;font-family:Montserrat,sans-serif;letter-spacing:.06em;text-transform:uppercase">Setup Summary</div>
        <div id="cncResSummary" class="tips" style="font-size:12px"></div>

      </div>
      <div id="cncOutEmpty" class="small" style="color:var(--muted)">Select material, bit, diameter and RPM — then hit Calculate.</div>
    </section>

    <!-- NOTES PANEL -->
    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">◎</span> Shop Notes</h2>
      <div id="cncNotesMat" style="display:none">
        <div style="font-size:11px;color:var(--accent);font-family:Montserrat,sans-serif;letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px" id="cncNotesMatLabel"></div>
        <div id="cncNotesMatBody" class="tips" style="font-size:12px;white-space:pre-wrap"></div>
        <div class="separator"></div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Lube / Coolant</div>
        <div id="cncNotesLube" class="tips" style="font-size:12px"></div>
        <div class="separator"></div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px">Direction</div>
        <div id="cncNotesClimb" class="tips" style="font-size:12px"></div>
      </div>
      <div id="cncNotesEmpty" class="small" style="color:var(--muted)">Calculate to load notes.</div>
    </section>

  </div><!-- /tool-grid row 1 -->

  <!-- ROW 2: SFM range gauge + general tips -->
  <div class="tool-grid" style="grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;align-items:start">

    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">◧</span> Bit Type Guide</h2>
      <div id="cncBitGuide" class="small" style="color:var(--muted)">Select a material to see bit guidance.</div>
    </section>

    <section class="panel">
      <h2 class="panel-title"><span class="panel-title-icon">⬡</span> Router Rules of Thumb</h2>
      <div class="tips" style="font-size:12px;white-space:pre-wrap">Chipload = feedrate ÷ (RPM × flutes)
Feedrate = RPM × flutes × chipload
SFM = (RPM × π × D_in) ÷ 12

Chipload is the master variable — tune everything else to hit it.
Too low chipload → rubbing → heat → dull bit → broken bit.
Too high chipload → chatter → broken bit.

Listen to the cut:
  ✓ Clean chip ejection, smooth hum = dialed in
  ✗ High-pitched screaming = too fast / dull
  ✗ Chatter / vibration = too aggressive or loose setup
  ✗ Burning smell = too slow or dull

Ramp entry: always preferred over straight plunge.
Climb vs conventional: climb for finish passes + aluminum.
Hold-down: if it can move, it will move — at the worst moment.</div>
    </section>

  </div>

</div><!-- /wrap -->
</div><!-- /tab-cnc -->


<!-- ══ DYTAT TAB ══════════════════════════════════════════════════════════ -->
<div id="tab-dytat" class="tabpanel" role="tabpanel">
  <div class="wrap">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap">
      <div class="dytat-progress-wrap" style="flex:1;min-width:280px;margin:0">
        <div class="progress-bar-track"><div class="progress-bar-fill" id="dytatBar"></div></div>
        <div class="progress-label"><strong id="dytatDone">0</strong> / <span id="dytatTotal">0</span> checked</div>
      </div>
      <div class="dytat-controls" style="margin:0">
        <button id="resetDytat" class="btn-ghost" style="
          background:transparent!important;border-color:var(--line)!important;color:var(--muted)!important">
          Reset all
        </button>
        <button id="printDytat">Print / Save PDF</button>
      </div>
    </div>

    <div class="dytat-callout">
      ☑ &nbsp;Check each box as you confirm it. Write <strong>N/A</strong> with a reason — not just a blank.
      A blank means you forgot. <strong>N/A means you thought about it.</strong>
    </div>

    <!-- ROW 1: Structure · Materials · Load -->
    <div class="dytat-grid">

      <!-- 01 Structure -->
      <div class="cat-card" style="--cat-color:#f5b146">
        <p class="cat-title">⬡ Structure &amp; Geometry <span class="cat-num">01</span></p>
        <ul class="checklist" data-cat="01">
          <li class="check-item"><label><input type="checkbox"><span><strong>Load path traced</strong> end-to-end to ground?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Clearances verified</strong> at all limits of motion &amp; deflection?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Tolerance stack-up</strong> analyzed — fits at worst case?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Datum scheme</strong> defined — stable and reproducible references?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Assembly sequence</strong> logical — physically possible in order?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Symmetry exploited</strong> or asymmetry clearly called out?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Weight &amp; CG shift</strong> assessed for vehicle dynamics?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Stiffness</strong> — deflection under load acceptable, not just strength?</span></label></li>
        </ul>
      </div>

      <!-- 02 Materials -->
      <div class="cat-card" style="--cat-color:#22d3ee">
        <p class="cat-title">◈ Materials &amp; Selection <span class="cat-num">02</span></p>
        <p class="sub-lbl">Selection</p>
        <ul class="checklist" data-cat="02a">
          <li class="check-item"><label><input type="checkbox"><span><strong>Material justified</strong> — why this alloy/grade/resin specifically?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Availability &amp; lead time</strong> acceptable? Any sole-source risk?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Cost</strong> checked against budget? Cheaper option considered?</span></label></li>
        </ul>
        <div class="cat-divider"></div>
        <p class="sub-lbl">Compatibility</p>
        <ul class="checklist" data-cat="02b">
          <li class="check-item"><label><input type="checkbox"><span><strong>Galvanic pairs</strong> — no bare aluminum-to-steel contact?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Thermal expansion mismatch</strong> at bonded/bolted joints?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Adhesive compatibility</strong> — cure temp, prep, open time?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Corrosion protection plan</strong> — spec, prep, coverage?</span></label></li>
        </ul>
      </div>

      <!-- 03 Load -->
      <div class="cat-card" style="--cat-color:#f87171">
        <p class="cat-title">↯ Load &amp; Environment <span class="cat-num">03</span></p>
        <p class="sub-lbl">Loads</p>
        <ul class="checklist" data-cat="03a">
          <li class="check-item"><label><input type="checkbox"><span><strong>Static load</strong> defined with magnitude and direction?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Dynamic factor</strong> applied — vibration, shock, road impact?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Fatigue</strong> — cycles at fraction of rated load considered?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Safety factor</strong> defined on yield and ultimate?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Worst-case</strong> — rock hit, pothole, water crossing defined?</span></label></li>
        </ul>
        <div class="cat-divider"></div>
        <p class="sub-lbl">Environment</p>
        <ul class="checklist" data-cat="03b">
          <li class="check-item"><label><input type="checkbox"><span><strong>Temp range</strong> — operating &amp; storage defined?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Water exposure</strong> — splash, submersion, drainage path?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>UV, dust, abrasion</strong> — protection planned?</span></label></li>
        </ul>
      </div>

    </div><!-- /row 1 -->

    <!-- ROW 2: DFM · Joining · QC -->
    <div class="dytat-grid">

      <!-- 04 Manufacturability -->
      <div class="cat-card" style="--cat-color:#34d399">
        <p class="cat-title">⚙ Manufacturability <span class="cat-num">04</span></p>
        <p class="sub-lbl">Design for Manufacture</p>
        <ul class="checklist" data-cat="04a">
          <li class="check-item"><label><input type="checkbox"><span><strong>Tool access</strong> — wrench, drill, weld gun reach every joint?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Part count minimized</strong> — any parts can be combined?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Standard hardware</strong> used — no exotic specials?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Self-locating features</strong> — tabs, slots, datums prevent errors?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Poka-yoke</strong> — impossible or obvious to assemble wrong?</span></label></li>
        </ul>
        <div class="cat-divider"></div>
        <p class="sub-lbl">Process</p>
        <ul class="checklist" data-cat="04b">
          <li class="check-item"><label><input type="checkbox"><span><strong>Jig / fixture</strong> requirements identified and planned?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Weld distortion plan</strong> — sequence, pre-camber, fixturing?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Surface finish / cosmetic spec</strong> called out clearly?</span></label></li>
        </ul>
      </div>

      <!-- 05 Joining -->
      <div class="cat-card" style="--cat-color:#fcd34d">
        <p class="cat-title">⬣ Joining &amp; Fastening <span class="cat-num">05</span></p>
        <p class="sub-lbl">Fasteners</p>
        <ul class="checklist" data-cat="05a">
          <li class="check-item"><label><input type="checkbox"><span><strong>Type, size, grade</strong> specified for every fastener?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Thread engagement</strong> adequate — ≥1.0× dia in steel, ≥1.5× in Al?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Torque spec</strong> called out — not just "snug"?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Thread-lock / locking feature</strong> for vibration environment?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Helicoil / STI insert</strong> needed in aluminum or composite?</span></label></li>
        </ul>
        <div class="cat-divider"></div>
        <p class="sub-lbl">Adhesive &amp; Weld</p>
        <ul class="checklist" data-cat="05b">
          <li class="check-item"><label><input type="checkbox"><span><strong>Bond area adequate</strong> for shear and peel loads?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Surface prep defined</strong> — grit, IPA wipe, primer, open time?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Weld spec</strong> — fillet size, process, filler, inspection class?</span></label></li>
        </ul>
      </div>

      <!-- 06 QC -->
      <div class="cat-card" style="--cat-color:#94a3b8">
        <p class="cat-title">◎ Inspection &amp; QC <span class="cat-num">06</span></p>
        <ul class="checklist" data-cat="06">
          <li class="check-item"><label><input type="checkbox"><span><strong>Critical dimensions</strong> identified and marked on drawing?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Measurement method</strong> — CMM, calipers, gauge, go/no-go?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>First article plan</strong> — who checks what, before production?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Visual acceptance criteria</strong> — what does "good" look like?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>In-process checks</strong> — stops a bad part from continuing downstream?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Functional test</strong> — does it do its job before install?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Non-conformance path</strong> — what happens when something fails?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Records</strong> — what gets documented and where?</span></label></li>
        </ul>
      </div>

    </div><!-- /row 2 -->

    <!-- ROW 3: System Integration · Safety · Serviceability -->
    <div class="dytat-grid-wide">

      <!-- 07 Integration (wider) -->
      <div class="cat-card" style="--cat-color:#22d3ee">
        <p class="cat-title">⟁ System Integration <span class="cat-num">07</span></p>
        <p class="sub-lbl">Interfaces</p>
        <ul class="checklist" data-cat="07a">
          <li class="check-item"><label><input type="checkbox"><span><strong>Electrical routing</strong> — harness conflicts, chafe, connector access?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Plumbing routing</strong> — abrasion, kink, freeze, drain path?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>HVAC / thermal</strong> — airflow blocked? Heat soak to adjacent parts?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Vendor / OEM dims</strong> confirmed from actual drawings — not memory?</span></label></li>
        </ul>
        <div class="cat-divider"></div>
        <p class="sub-lbl">BOM &amp; Change Impact</p>
        <ul class="checklist" data-cat="07b">
          <li class="check-item"><label><input type="checkbox"><span><strong>New parts</strong> — BOM updated, supplier ID'd, lead time checked?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Superseded parts</strong> — existing inventory disposition plan?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Affects existing builds?</strong> — retrofit needed? Customer notification?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>ECO triggered?</strong> — change documented before first production use?</span></label></li>
        </ul>
      </div>

      <!-- 08 Safety -->
      <div class="cat-card" style="--cat-color:#f87171">
        <p class="cat-title">△ Safety <span class="cat-num">08</span></p>
        <ul class="checklist" data-cat="08">
          <li class="check-item"><label><input type="checkbox"><span><strong>Sharp edges / pinch points</strong> addressed?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Fail mode</strong> — safe-fail or sudden-fail?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Regulatory</strong> — DOT, FMVSS, or TH policy applies?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Overload path</strong> — where does force go if over-rated?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Warnings / labels</strong> needed on the part or in the WI?</span></label></li>
        </ul>
      </div>

      <!-- 09 Serviceability -->
      <div class="cat-card" style="--cat-color:#34d399">
        <p class="cat-title">↺ Serviceability <span class="cat-num">09</span></p>
        <ul class="checklist" data-cat="09">
          <li class="check-item"><label><input type="checkbox"><span><strong>Field-repairable</strong> with common tools, no special equipment?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Wear items</strong> — accessible, replaceable without major disassembly?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Work instruction</strong> — needed and written before ship?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Torque specs &amp; procedures</strong> captured where a tech needs them?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span><strong>Spare parts</strong> — critical consumables in stock or on the list?</span></label></li>
        </ul>
      </div>

    </div><!-- /row 3 -->

    <!-- BOTTOM BANNER -->
    <div class="dytat-banner">
      <div class="banner-col">
        <div class="banner-lbl">💲 Cost &amp; Schedule</div>
        <ul class="checklist" data-cat="B1">
          <li class="check-item"><label><input type="checkbox"><span>Unit cost target checked?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Tolerances only as tight as needed?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Long-lead items identified early?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Tooling cost in budget?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Make vs. buy decided?</span></label></li>
        </ul>
      </div>
      <div class="banner-col">
        <div class="banner-lbl">📐 Drawing Gate</div>
        <ul class="checklist" data-cat="B2">
          <li class="check-item"><label><input type="checkbox"><span>Title block complete — PN, rev, material?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>GD&amp;T correct and complete?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>All notes unambiguous — no TBDs?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Supplier could quote from this alone?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Peer review completed &amp; signed?</span></label></li>
        </ul>
      </div>
      <div class="banner-col">
        <div class="banner-lbl">⬡ Composite &amp; Bond</div>
        <ul class="checklist" data-cat="B3">
          <li class="check-item"><label><input type="checkbox"><span>Carbon dust / conductivity addressed?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Hardpoints / inserts for fasteners?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Backer, tape, vacuum on drill plan?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>No oily coolants before bonded surfaces?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Cure temp &amp; time spec'd, achievable?</span></label></li>
        </ul>
      </div>
      <div class="banner-col">
        <div class="banner-lbl">📋 Documentation</div>
        <ul class="checklist" data-cat="B4">
          <li class="check-item"><label><input type="checkbox"><span>Design Intent Brief (Tier 1) filed?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Tier 2 DCR required? Started?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>CAD in correct folder, named correctly?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>BOM updated and matched to CAD?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Work instruction written or linked?</span></label></li>
        </ul>
      </div>
      <div class="banner-col">
        <div class="banner-lbl">🚀 Before You Release</div>
        <ul class="checklist" data-cat="B5">
          <li class="check-item"><label><input type="checkbox"><span>No open TBDs on released drawings?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>Dry-fit or prototype verified fit?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>At least one other engineer reviewed it?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>ECO initiated if change to existing?</span></label></li>
          <li class="check-item"><label><input type="checkbox"><span>You'd be comfortable if a customer asked why?</span></label></li>
        </ul>
      </div>
    </div><!-- /banner -->

  </div><!-- /wrap -->
</div><!-- /tab-dytat -->

<!-- ══ SHEET METAL TAB ═══════════════════════════════════════════════════ -->
<div id="tab-sheetmetal" class="tabpanel" role="tabpanel">
<div class="wrap">

  <!-- ROW 1: Gauge Lookup + Bend Spec + Material Ref -->
  <div class="tool-grid">

    <!-- GAUGE LOOKUP -->
    <section class="panel">
      <h2>Gauge → Thickness</h2>
      <div class="row">
        <div>
          <label>Material</label>
          <select id="smMatSel">
            <option value="mildSteel">Mild Steel (A36/1008)</option>
            <option value="stainless">304 Stainless Steel</option>
            <option value="aluminum5052">5052-H32 Aluminum</option>
          </select>
        </div>
        <div>
          <label>Gauge # or decimal (in)</label>
          <input id="smGaugeIn" list="smGaugeList" placeholder="e.g. 14  or  0.075">
          <datalist id="smGaugeList"></datalist>
        </div>
        <div style="align-self:flex-end"><button id="smGaugeLook">Look up</button></div>
      </div>
      <div id="smGaugeOut" class="tips" style="margin-top:10px;display:none"></div>
      <div class="separator"></div>
      <h2 style="margin-top:0;font-size:12px">Full Gauge Chart</h2>
      <div id="smGaugeTable" style="overflow-x:auto;margin-top:4px"></div>
    </section>

    <!-- BEND SPEC LOOKUP -->
    <section class="panel">
      <h2>Bend Specs <span style="font-weight:400;color:var(--muted);font-size:11px">(SCS air-bend)</span></h2>
      <p class="small" style="margin:0 0 10px;color:var(--muted)">Inside radius, K-factor &amp; min flange for <a href="https://sendcutsend.com/bending-calculator/" target="_blank" style="color:var(--accent-2)">SendCutSend</a> tooling. Always verify on their calculator before ordering.</p>
      <div class="row">
        <div>
          <label>Material</label>
          <select id="smBendMat">
            <option value="mildSteel">Mild Steel</option>
            <option value="stainless304">304 Stainless</option>
            <option value="aluminum5052">5052-H32 Aluminum</option>
          </select>
        </div>
        <div>
          <label>Gauge # or thickness (in)</label>
          <input id="smBendThick" list="smBendList" placeholder="e.g. 14  or  0.075">
          <datalist id="smBendList"></datalist>
        </div>
        <div style="align-self:flex-end"><button id="smBendLook">Get specs</button></div>
      </div>
      <div id="smBendOut" class="tips" style="margin-top:10px;display:none"></div>

      <div class="separator"></div>
      <h2 style="margin-top:0;font-size:12px">Bend Deduction Quick Calc <span style="font-weight:400;color:var(--muted)">(90°)</span></h2>
      <p class="small" style="margin:0 0 8px;color:var(--muted)">BD = 2×(R + T) – BA, where BA = (π/2)×(R + K×T)</p>
      <div class="row">
        <div><label>Inside Radius (in)</label><input id="smBdR" type="number" step="0.001" placeholder="0.060"></div>
        <div><label>Thickness (in)</label><input id="smBdT" type="number" step="0.001" placeholder="0.060"></div>
        <div><label>K-Factor</label><input id="smBdK" type="number" step="0.01" value="0.44"></div>
      </div>
      <button id="smBdCalc" style="margin-top:8px">Calculate</button>
      <div id="smBdOut" class="tips" style="margin-top:10px;display:none"></div>
    </section>

    <!-- MATERIAL CARDS -->
    <section class="panel">
      <h2>Material Reference</h2>
      <div class="row" style="margin-bottom:8px">
        <div><label>Material</label><select id="smMatRef"><option value="">— select —</option></select></div>
        <div style="align-self:flex-end"><button id="smMatRefGo">Show</button></div>
      </div>
      <div id="smMatRefOut" style="display:none">
        <div id="smMatRefSummary" class="tips" style="margin-bottom:8px"></div>
        <div id="smMatRefDetail" class="tips"></div>
      </div>
    </section>

  </div><!-- /row 1 -->

  <!-- ROW 2: Design Rules + Tips -->
  <div class="tool-grid" style="margin-top:16px;grid-template-columns:1.4fr 1fr 0fr">

    <!-- DESIGN RULES — spans 2 cols -->
    <section class="panel" style="grid-column:span 2">
      <h2>Design Rules Quick Reference</h2>
      <div class="row">
        <div>
          <label>Category</label>
          <select id="smRuleSel">
            <option value="slotsAndTabs">Slots &amp; Tabs (laser fit-up)</option>
            <option value="holeDesign">Hole Design</option>
            <option value="bendReliefs">Bend Reliefs</option>
            <option value="flangeMinimums">Min Flange Lengths (SCS)</option>
          </select>
        </div>
        <div style="align-self:flex-end"><button id="smRuleGo">Show rules</button></div>
      </div>
      <div id="smRuleOut" style="margin-top:10px;display:none"></div>
    </section>

    <!-- FAB TIPS -->
    <section class="panel">
      <h2>Fab Tips</h2>
      <select id="smTipSel" style="margin-bottom:8px"><option value="">— pick a topic —</option></select>
      <div id="smTipOut" class="tips" style="display:none"></div>
      <div class="separator"></div>
      <button id="smTipAll">Show all tips</button>
      <div id="smTipAllOut" style="margin-top:10px;display:none"></div>
    </section>

  </div><!-- /row 2 -->

</div><!-- /wrap -->
</div><!-- /tab-sheetmetal -->


<!-- ══ SCRIPTS ═══════════════════════════════════════════════════════════ -->
<script>
/* ── Brand ─────────────────────────────────────────────────────────── */
const LOGO_URL='./th-logo.png';
const logo=document.getElementById('thLogo');
logo.src=LOGO_URL;
logo.onerror=()=>{console.warn('Logo not found:',LOGO_URL)};

/* ── Tab switching ──────────────────────────────────────────────────── */
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>{t.classList.remove('active');t.setAttribute('aria-selected','false')});
    document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    tab.setAttribute('aria-selected','true');
    document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
  });
});

/* ── DB ─────────────────────────────────────────────────────────────── */
const DB_CACHE_KEY='TH_DB_CACHE_V1';
let DB={version:'',materials:[],fasteners:[],sheetMetalPilots:{},woodPilots:{}};

const LETTER_DRILLS={A:.234,B:.238,C:.242,D:.246,E:.250,F:.257,G:.261,H:.266,I:.272,J:.277,K:.281,L:.290,M:.295,N:.302,O:.316,P:.323,Q:.332,R:.339,S:.348,T:.358,U:.368,V:.377,W:.386,X:.397,Y:.404,Z:.413};
const NUMBER_DRILLS={80:.0135,79:.0145,78:.016,77:.018,76:.020,75:.021,74:.0225,73:.024,72:.025,71:.026,70:.028,69:.0292,68:.031,67:.032,66:.033,65:.035,64:.036,63:.037,62:.038,61:.039,60:.040,59:.041,58:.042,57:.043,56:.0465,55:.052,54:.055,53:.0595,52:.0635,51:.067,50:.070,49:.073,48:.076,47:.0785,46:.081,45:.082,44:.086,43:.089,42:.0935,41:.096,40:.098,39:.0995,38:.1015,37:.104,36:.1065,35:.110,34:.111,33:.113,32:.116,31:.120,30:.1285,29:.136,28:.1405,27:.144,26:.147,25:.1495,24:.152,23:.154,22:.157,21:.159,20:.161,19:.166,18:.1695,17:.173,16:.177,15:.180,14:.182,13:.185,12:.189,11:.191,10:.1935,9:.196,8:.199,7:.201,6:.204,5:.2055,4:.209,3:.213,2:.221,1:.228};

function parseFraction(s){const m=String(s).trim().match(/^(\d+)\s*\/\s*(\d+)$/);if(!m)return NaN;const num=+m[1],den=+m[2];return den?num/den:NaN;}
function parseTokenToInches(tok){if(!tok)return null;const s=String(tok).trim();const mm=s.match(/^(\d+(?:\.\d+)?)\s*mm$/i);if(mm)return parseFloat(mm[1])/25.4;if(/^\d+(\.\d+)?$/.test(s))return parseFloat(s);const fr=parseFraction(s);if(!isNaN(fr))return fr;if(/^[A-Z]$/i.test(s))return LETTER_DRILLS[s.toUpperCase()]||null;const nd=s.match(/^#\s*(\d{1,2})$/);if(nd)return NUMBER_DRILLS[+nd[1]]||null;return null;}
function mmToInches(mm){return parseFloat(mm)/25.4;}
const DRILL_CATALOG=(()=>{const arr=[];for(const[n,v]of Object.entries(NUMBER_DRILLS))arr.push({label:'#'+n,inch:+v});for(const[ch,v]of Object.entries(LETTER_DRILLS))arr.push({label:ch,inch:+v});for(let i=1;i<=64;i++)arr.push({label:`${i}/64`,inch:i/64});arr.sort((a,b)=>a.inch-b.inch);return arr;})();
function nearestUsDrill(inches){let best=null,d=Infinity;for(const it of DRILL_CATALOG){const diff=Math.abs(it.inch-inches);if(diff<d){best=it;d=diff;}}return d<=0.002?{...best,diff:d}:null;}
function fmtMetricDrill(mmVal){const mm=parseFloat(mmVal);if(!(mm>0))return`${mmVal} mm`;const inches=mmToInches(mm);const near=nearestUsDrill(inches);const inTxt=inches.toFixed(4)+' in';return near?`${mm.toFixed(2)} mm (${inTxt} ≈ ${near.label})`:`${mm.toFixed(2)} mm (${inTxt})`;}
function fmtClear(units,val){if(val==null||isNaN(val))return'—';return units==='mm'?fmtMetricDrill(val):`${(+val).toFixed(3)} in`;}

let MAT_BY_CANON=new Map(),ALIAS=new Map(),FZ_BY_SIZE=new Map();
function rebuildLookups(){
  MAT_BY_CANON.clear();ALIAS.clear();FZ_BY_SIZE.clear();
  (DB.materials||[]).forEach(m=>{const k=(m.name||'').toLowerCase();if(!k)return;MAT_BY_CANON.set(k,m);(m.aliases||[]).forEach(a=>ALIAS.set(String(a).toLowerCase(),k));});
  (DB.fasteners||[]).forEach(f=>{if(f.size)FZ_BY_SIZE.set(f.size,String(f.size));});
}
function populateMatList(){const dl=document.getElementById('matList');dl.innerHTML='';const seen=new Set();(DB.materials||[]).forEach(m=>{const key=(m.name||'').toLowerCase();if(!key||seen.has(key))return;seen.add(key);const o=document.createElement('option');o.value=m.name;dl.appendChild(o);});(DB.materials||[]).forEach(m=>(m.aliases||[]).forEach(a=>{const o=document.createElement('option');o.value=a;dl.appendChild(o);}));}
function populateFzList(){const dl=document.getElementById('fzList');dl.innerHTML='';const sizes=(DB.fasteners||[]).map(f=>f.size).filter(Boolean);sizes.sort((a,b)=>a.replace('M','~').localeCompare(b.replace('M','~'))).forEach(s=>{const o=document.createElement('option');o.value=s;dl.appendChild(o);});}
function canonMaterial(name){if(!name)return null;const s=name.toLowerCase().trim();if(MAT_BY_CANON.has(s))return s;if(ALIAS.has(s))return ALIAS.get(s);if(s.includes('6061'))return'6061 aluminum';if(s.includes('7075'))return'7075 aluminum';if(s.includes('stainless'))return'300 stainless';if(s.includes('chromoly')||s.includes('4130'))return'4130 chromoly';return null;}

function showEl(id,show){const el=document.getElementById(id);if(el)el.style.display=show?'':'none';}

function showMaterial(){
  const raw=(document.getElementById('matInput').value||'').trim();
  const outS=document.getElementById('matSummary'),outD=document.getElementById('matDetails');
  outS.textContent='';outD.textContent='';showEl('matSummary',false);showEl('matDetails',false);
  if(!(DB.materials||[]).length){outS.textContent='No DB loaded yet. Drop shopdb.json in the Database panel.';showEl('matSummary',true);return;}
  const key=canonMaterial(raw);
  if(!key){outS.textContent=`Not found: "${raw}". Try a listed material or alias.`;showEl('matSummary',true);return;}
  const m=MAT_BY_CANON.get(key);
  if(!m){outS.textContent=`"${raw}" resolved to "${key}" but no record found.`;showEl('matSummary',true);return;}
  outS.innerHTML=`<span class="pill">${m.name}</span>${(m.tags||[]).map(t=>`<span class="pill">${t}</span>`).join(' ')}`+(m.summary?`\n\n${m.summary}`:'');
  showEl('matSummary',true);
  const blocks=[];
  if(m.drilling?.length)blocks.push('Drilling — Do this:\n• '+m.drilling.join('\n• '));
  if(m.tapping?.length) blocks.push('Tapping — If applicable:\n• '+m.tapping.join('\n• '));
  if(m.holesaw?.length) blocks.push('Hole Sawing — Tips:\n• '+m.holesaw.join('\n• '));
  if(m.notes?.length)   blocks.push('Street Knowledge:\n• '+m.notes.join('\n• '));
  if(m.tapType||m.lube||m.fit||m.tapPercent)blocks.push(`Fastener context: tap ${m.tapPercent||'—'} • ${m.tapType||'—'} • lube: ${m.lube||'—'} • fit: ${m.fit||'—'}`);
  if(blocks.length){outD.textContent=blocks.join('\n\n');showEl('matDetails',true);}
}

const SFM={aluminum:[200,300],steel:[60,100],stainless:[30,50],composite:[40,80],plastic:[40,80],wood:[150,300],wood_dense:[120,220],foam:[10,30]};
function holesawCalc(){
  const raw=(document.getElementById('matInput').value||'').trim();
  const d=parseFloat(document.getElementById('hsDia').value);
  const units=document.getElementById('hsUnits').value;
  const out=document.getElementById('hsOut');
  out.textContent='';showEl('hsOut',false);
  const key=canonMaterial(raw);const m=key&&MAT_BY_CANON.get(key);
  if(!m){out.textContent='Pick a material first.';showEl('hsOut',true);return;}
  if(!(d>0)){out.textContent='Enter a diameter.';showEl('hsOut',true);return;}
  const cat=m.sfmCategory||'steel';const[lo,hi]=SFM[cat]||[60,100];
  const dIn=(units==='mm')?d/25.4:d;
  const rpmLo=Math.max(60,Math.round((lo*3.82)/dIn));
  const rpmHi=Math.max(rpmLo+1,Math.round((hi*3.82)/dIn));
  out.textContent=`Category: ${cat}\nDiameter: ${dIn.toFixed(3)} in\nSFM: ${lo}–${hi}\nRPM: ${rpmLo} – ${rpmHi}`;
  showEl('hsOut',true);
}

function computeClearance(fz,fit){
  const sys=fz.system;
  const close=(fz.clearClose!=null&&fz.clearClose!=='')?+fz.clearClose:null;
  const std=(fz.clearStandard!=null&&fz.clearStandard!=='')?+fz.clearStandard:null;
  const loose=(fz.clearLoose!=null&&fz.clearLoose!=='')?+fz.clearLoose:null;
  if(close||std||loose){const table={close,standard:std,loose};const best=table[fit]??table.standard??table.close??table.loose;return{close,standard:std,loose,preferred:best,units:(sys==='metric'?'mm':'in')};}
  if(sys==='metric'){const maj=parseFloat((fz.size.match(/^M(\d+(?:\.\d+)?)/)||[])[1]||NaN);if(!isNaN(maj)){const closeV=+(maj+(maj<=8?0.4:0.5)).toFixed(1);const stdV=+(maj+1.0).toFixed(1);const looseV=+(stdV+0.5).toFixed(1);const pref=({close:closeV,standard:stdV,loose:looseV})[fit];return{close:closeV,standard:stdV,loose:looseV,preferred:pref,units:'mm'};}}
  else{let maj=null;const hash=fz.size.match(/^#(\d+)-/);if(hash){maj=0.060+0.013*parseInt(hash[1],10);}const frac=fz.size.match(/^(\d+\/\d+|\d*\.?\d+)-/);if(!maj&&frac){maj=frac[1].includes('/')?parseFraction(frac[1]):parseFloat(frac[1]);}if(!maj)maj=0.190;let addC=0,addF=0.01;if(maj<=0.190){addC=0;addF=0.010}else if(maj<=0.25){addC=0.005;addF=0.010}else if(maj<=0.375){addC=0.010;addF=0.011}else if(maj<=0.5){addC=0.012;addF=0.016}else{addC=0.015;addF=0.020}const closeV=+(maj+addC).toFixed(3);const stdV=+(maj+addC+addF).toFixed(3);const looseV=+(stdV+0.010).toFixed(3);const pref=({close:closeV,standard:stdV,loose:looseV})[fit];return{close:closeV,standard:stdV,loose:looseV,preferred:pref,units:'in'};}
  return{close:null,standard:null,loose:null,preferred:null,units:(sys==='metric'?'mm':'in')};
}

function calcFastener(){
  const kind=document.getElementById('kind').value;
  const size=(document.getElementById('fz').value||'').trim();
  const fit=document.getElementById('fit').value;
  const sti=document.getElementById('sti').checked;
  const out=document.getElementById('fzOut');
  out.textContent='';showEl('fzOut',false);
  if(!(DB.fasteners||[]).length){out.textContent='No DB loaded yet. Drop shopdb.json in the Database panel.';showEl('fzOut',true);return;}
  if(!size){out.textContent='Enter a size.';showEl('fzOut',true);return;}
  if(kind!=='machine'){
    if(kind==='sheetmetal'){const m=size.match(/#\s*(\d+)/);if(!m)return(out.textContent='Use #6, #8, #10, #12.',showEl('fzOut',true));const v=(DB.sheetMetalPilots||{})['#'+m[1]];out.textContent=v?`#${m[1]} sheet metal pilot: ${v}`:'Not in pilot table.';}
    else{const m=size.match(/#\s*(\d+)/);if(!m)return(out.textContent='Use #6, #8, #10, #12.',showEl('fzOut',true));const row=(DB.woodPilots||{})['#'+m[1]];out.textContent=row?`#${m[1]} wood pilots\nSoftwood: ${row.softwood}\nHardwood: ${row.hardwood}`:'Not in wood pilot table.';}
    showEl('fzOut',true);return;
  }
  const f=(DB.fasteners||[]).find(x=>String(x.size)===size);
  if(!f){out.textContent=`Size not found: "${size}"`;showEl('fzOut',true);return;}
  let tap75=f.tap75,tap50=f.tap50;
  if(!tap75||!tap50){const inch=f.system==='inch';if(inch&&f.tpi){const majorGuess=size.startsWith('#')?(0.060+0.013*parseInt(size.match(/^#(\d+)/)[1],10)):(size.match(/^(\d+\/\d+|\d*\.?\d+)-/)?(s=>s.includes('/')?parseFraction(s):parseFloat(s))(RegExp.$1):NaN);const pitch=1/parseInt(f.tpi,10);tap75=tap75||(majorGuess-pitch).toFixed(4);tap50=tap50||(majorGuess-0.5*pitch).toFixed(4);}else if(!inch&&f.pitch){const major=parseFloat(size.match(/^M(\d+(?:\.\d+)?)/)[1]);tap75=tap75||(major-f.pitch).toFixed(2);tap50=tap50||(major-0.5*f.pitch).toFixed(2);}}
  let stiTap=f.stiTap||null;if(!stiTap&&f.stiTapToken){const inch=f.system==='inch';const valIn=parseTokenToInches(f.stiTapToken);stiTap=valIn?(inch?valIn.toFixed(4):(valIn*25.4).toFixed(2)):f.stiTapToken;}
  const clr=computeClearance(f,fit);
  const tap75Txt=f.system==='metric'&&tap75?fmtMetricDrill(tap75):(tap75?`${tap75} ${f.system==='metric'?'mm':'in'}`:'—');
  const tap50Txt=f.system==='metric'&&tap50?fmtMetricDrill(tap50):(tap50?`${tap50} ${f.system==='metric'?'mm':'in'}`:'—');
  const stiTxt=f.system==='metric'&&stiTap?fmtMetricDrill(stiTap):(stiTap?`${stiTap} ${f.system==='metric'?'mm':'in'}`:'—');
  const lines=[
    `Size: ${f.size} (${f.system})`,
    f.tpi?`Pitch: ${f.tpi} TPI`:(f.pitch?`Pitch: ${f.pitch} mm`:''),
    sti?`STI tap drill: ${stiTxt}`:`Tap drill — 75%: ${tap75Txt}\nTap drill — 50%: ${tap50Txt}`,
    '',
    `Preferred clearance (${fit}): ${fmtClear(clr.units,clr.preferred)}`,
    `Menu — close: ${fmtClear(clr.units,clr.close)},  standard: ${fmtClear(clr.units,clr.standard)},  loose: ${fmtClear(clr.units,clr.loose)}`
  ].filter(Boolean);
  out.textContent=lines.join('\n');showEl('fzOut',true);
}

/* ── DB file handling ───────────────────────────────────────────────── */
const drop=document.getElementById('drop'),file=document.getElementById('file');
function setStatus(html){document.getElementById('dbStatus').innerHTML=html;}
function flashOK(){drop.classList.add('ok-flash');setTimeout(()=>drop.classList.remove('ok-flash'),700);}
function handleFiles(files){
  if(!files||!files.length){setStatus('<span class="warn">No file provided.</span>');return;}
  const f=files[0];
  if(!/\.json$/i.test(f.name)){setStatus(`<span class="bad">Not a .json file:</span> ${f.name}`);return;}
  setStatus(`Reading <em>${f.name}</em>…`);
  const reader=new FileReader();
  reader.onerror=()=>setStatus('<span class="bad">Read error.</span>');
  reader.onload=()=>{try{ingestDB(JSON.parse(reader.result),f.name);}catch(e){setStatus(`<span class="bad">Parse error:</span> ${e.message}`);}};
  reader.readAsText(f);
}
function validateDB(obj){if(!obj||typeof obj!=='object')return'Not an object';if(!Array.isArray(obj.materials))return'Missing "materials" array';if(!Array.isArray(obj.fasteners))return'Missing "fasteners" array';return null;}
function ingestDB(obj,src){
  const err=validateDB(obj);if(err){setStatus(`<span class="bad">Load failed:</span> ${err}`);return;}
  DB=obj;rebuildLookups();populateMatList();populateFzList();
  try{localStorage.setItem(DB_CACHE_KEY,JSON.stringify(DB));}catch(e){console.warn('Cache write failed:',e);}
  setStatus(`<span class="ok">Loaded</span> ${DB.materials.length} materials, ${DB.fasteners.length} fasteners from ${src||'file'}. Cached for offline use.`);
  flashOK();
  // Sheet metal tab refresh
  if(typeof smBoot==='function') smBoot();
  if(typeof fdmBoot==='function') fdmBoot();
  // Insert calculator refresh
  if(typeof insBoot==='function') insBoot();
  // CNC router refresh
  if(typeof cncBoot==='function') cncBoot();
}
document.getElementById('exportDb').onclick=()=>{const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='shopdb.json';document.body.appendChild(a);a.click();a.remove();};
document.getElementById('clearDb').onclick=()=>{localStorage.removeItem(DB_CACHE_KEY);DB={version:'',materials:[],fasteners:[],sheetMetalPilots:{},woodPilots:{}};rebuildLookups();populateMatList();populateFzList();setStatus('<span class="warn">Cleared.</span> Drop a DB to begin.');};
drop.addEventListener('click',()=>file.click());
drop.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();file.click();}});
file.addEventListener('change',e=>handleFiles(e.target.files));
drop.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='copy';drop.classList.add('drag');});
drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');handleFiles(e.dataTransfer.files);});

/* Boot */
(function(){try{const cached=localStorage.getItem(DB_CACHE_KEY);if(cached){ingestDB(JSON.parse(cached),'cache');}else{setStatus('<span class="warn">No database loaded.</span> Drop <code>shopdb.json</code> above to start.');}}catch(e){setStatus(`<span class="bad">Cache error:</span> ${e.message}`);}})();

/* ── Wiring ─────────────────────────────────────────────────────────── */
document.getElementById('matGo').onclick=showMaterial;
document.getElementById('matInput').addEventListener('keydown',e=>{if(e.key==='Enter')showMaterial();});
document.getElementById('hsCalc').onclick=holesawCalc;
document.getElementById('calc').onclick=calcFastener;
document.getElementById('fz').addEventListener('keydown',e=>{if(e.key==='Enter')calcFastener();});

/* ── DYTAT checklist logic ──────────────────────────────────────────── */
const DYTAT_KEY='TH_DYTAT_V1';

function dytatUpdate(){
  const allBoxes=document.querySelectorAll('#tab-dytat input[type=checkbox]');
  const total=allBoxes.length;
  const done=[...allBoxes].filter(b=>b.checked).length;
  const pct=total?Math.round(done/total*100):0;
  document.getElementById('dytatBar').style.width=pct+'%';
  document.getElementById('dytatDone').textContent=done;
  document.getElementById('dytatTotal').textContent=total;
  // Persist
  const state={};allBoxes.forEach((b,i)=>{state[i]=b.checked;});
  try{localStorage.setItem(DYTAT_KEY,JSON.stringify(state));}catch(e){}
}

function dytatLoad(){
  try{
    const saved=localStorage.getItem(DYTAT_KEY);
    if(!saved)return;
    const state=JSON.parse(saved);
    const allBoxes=document.querySelectorAll('#tab-dytat input[type=checkbox]');
    allBoxes.forEach((b,i)=>{if(state[i])b.checked=true;});
  }catch(e){}
}

// Wire up all checkboxes
document.querySelectorAll('#tab-dytat input[type=checkbox]').forEach(cb=>{
  cb.addEventListener('change',dytatUpdate);
});

document.getElementById('resetDytat').onclick=()=>{
  if(!confirm('Reset all checklist items?'))return;
  document.querySelectorAll('#tab-dytat input[type=checkbox]').forEach(cb=>cb.checked=false);
  try{localStorage.removeItem(DYTAT_KEY);}catch(e){}
  dytatUpdate();
};

document.getElementById('printDytat').onclick=()=>{
  window.print();
};

// Boot checklist
dytatLoad();
dytatUpdate();

/* ══════════════════════════════════════════════════════════════════════
   SHEET METAL TAB — JS
══════════════════════════════════════════════════════════════════════ */

// ── Gauge chart table renderer ──────────────────────────────────────
function smRenderGaugeTable(matKey){
  const SM=DB.sheetMetal;
  if(!SM){return'<span class="warn">Load a DB with sheetMetal data.</span>';}
  const rows=SM.gaugeCharts[matKey];
  if(!rows||!rows.length)return'<span class="warn">No data for that material.</span>';
  let t=`<table style="width:100%;border-collapse:collapse;font-size:12px;font-family:var(--mono)">
    <thead><tr>
      <th style="text-align:left;padding:4px 8px;border-bottom:1px solid var(--line);color:var(--muted)">Gauge</th>
      <th style="text-align:right;padding:4px 8px;border-bottom:1px solid var(--line);color:var(--muted)">Inches</th>
      <th style="text-align:right;padding:4px 8px;border-bottom:1px solid var(--line);color:var(--muted)">mm</th>
    </tr></thead><tbody>`;
  rows.forEach(r=>{
    t+=`<tr style="border-bottom:1px solid rgba(31,43,56,0.6)">
      <td style="padding:4px 8px;color:var(--accent)">${r.gauge}ga</td>
      <td style="padding:4px 8px;text-align:right">${r.in.toFixed(4)}"</td>
      <td style="padding:4px 8px;text-align:right">${r.mm.toFixed(3)} mm</td>
    </tr>`;
  });
  t+=`</tbody></table>`;
  return t;
}

function smGaugeLookup(){
  const matKey=document.getElementById('smMatSel').value;
  const raw=(document.getElementById('smGaugeIn').value||'').trim();
  const out=document.getElementById('smGaugeOut');
  const SM=DB.sheetMetal;
  if(!SM){out.textContent='Load shopdb.json first.';out.style.display='';return;}
  const rows=SM.gaugeCharts[matKey];
  if(!rows){out.textContent='No gauge chart for this material.';out.style.display='';return;}

  // Try matching gauge number or decimal thickness
  const num=parseFloat(raw);
  let match=null;
  if(!isNaN(num)){
    if(num>=1&&num<=30&&Number.isInteger(num)){
      match=rows.find(r=>r.gauge===num);
    }
    if(!match){
      // decimal match — find closest
      let best=null,bd=Infinity;
      rows.forEach(r=>{const d=Math.abs(r.in-num);if(d<bd){bd=d;best=r;}});
      if(best&&Math.abs(best.in-num)<0.005)match=best;
    }
  }
  if(!match){out.textContent=`No match for "${raw}". Enter a gauge number (7–26) or decimal thickness.`;out.style.display='';return;}

  const matNames={mildSteel:'Mild Steel',stainless:'304 Stainless',aluminum5052:'5052-H32 Aluminum'};
  out.textContent=`${matNames[matKey]} — ${match.gauge}ga\n  ${match.in.toFixed(4)}" = ${match.mm.toFixed(3)} mm`;
  out.style.display='';
}

// ── Populate gauge table on material change ──────────────────────────
function smRefreshGaugeTable(){
  const matKey=document.getElementById('smMatSel').value;
  document.getElementById('smGaugeTable').innerHTML=smRenderGaugeTable(matKey);
}

// ── Bend spec lookup ─────────────────────────────────────────────────
function smBendLookup(){
  const matKey=document.getElementById('smBendMat').value;
  const raw=(document.getElementById('smBendThick').value||'').trim();
  const out=document.getElementById('smBendOut');
  const SM=DB.sheetMetal;
  if(!SM){out.textContent='Load shopdb.json first.';out.style.display='';return;}
  const rows=SM.sendCutSendBendSpecs[matKey];
  if(!rows){out.textContent='No bend data for this material.';out.style.display='';return;}

  const num=parseFloat(raw);
  let match=null;
  if(!isNaN(num)){
    if(num>=1&&num<=30&&Number.isInteger(num)){
      match=rows.find(r=>r.gauge===num||r.gauge===String(num));
    }
    if(!match){
      let best=null,bd=Infinity;
      rows.forEach(r=>{const d=Math.abs(r.thickness-num);if(d<bd){bd=d;best=r;}});
      if(best&&Math.abs(best.thickness-num)<0.010)match=best;
    }
  }
  if(!match){out.textContent=`No match for "${raw}". Try a gauge number or thickness like 0.075.`;out.style.display='';return;}

  const gLabel=typeof match.gauge==='number'?`${match.gauge}ga`:`${match.gauge}`;
  const lines=[
    `${gLabel}  —  ${match.thickness.toFixed(3)}"`,
    `Inside bend radius : ${match.bendRadius.toFixed(3)}"`,
    `K-factor           : ${match.kFactor}`,
    `Bend deduction (90°): ${match.bendDeduction.toFixed(3)}"`,
    `Min flange length  : ${match.minFlange}"`,
    match.note?`Note: ${match.note}`:null,
    `\nSCS calculator → sendcutsend.com/bending-calculator/`
  ].filter(Boolean);
  out.textContent=lines.join('\n');
  out.style.display='';
}

// ── Bend deduction calc ──────────────────────────────────────────────
function smBdCalc(){
  const R=parseFloat(document.getElementById('smBdR').value);
  const T=parseFloat(document.getElementById('smBdT').value);
  const K=parseFloat(document.getElementById('smBdK').value);
  const out=document.getElementById('smBdOut');
  if(isNaN(R)||isNaN(T)||isNaN(K)||R<=0||T<=0||K<=0){
    out.textContent='Enter valid radius, thickness, and K-factor.';out.style.display='';return;
  }
  const BA=(Math.PI/2)*(R+K*T);
  const BD=2*(R+T)-BA;
  const neutral=R+K*T;
  out.textContent=[
    `Bend allowance (BA) : ${BA.toFixed(4)}"`,
    `Bend deduction (BD) : ${BD.toFixed(4)}"`,
    `Neutral axis radius : ${neutral.toFixed(4)}"`,
    ``,
    `Flat length = (Leg1 from apex) + (Leg2 from apex) – BD`,
  ].join('\n');
  out.style.display='';
}

// ── Material reference card ──────────────────────────────────────────
function smPopulateMatRef(){
  const sel=document.getElementById('smMatRef');
  sel.innerHTML='<option value="">— select —</option>';
  const SM=DB.sheetMetal;
  if(!SM||!SM.materials)return;
  SM.materials.forEach(m=>{
    const o=document.createElement('option');
    o.value=m.id;o.textContent=m.name;
    sel.appendChild(o);
  });
}

function smShowMatRef(){
  const id=document.getElementById('smMatRef').value;
  const outWrap=document.getElementById('smMatRefOut');
  const outSum=document.getElementById('smMatRefSummary');
  const outDet=document.getElementById('smMatRefDetail');
  outWrap.style.display='none';
  const SM=DB.sheetMetal;
  if(!SM||!id)return;
  const m=SM.materials.find(x=>x.id===id);
  if(!m)return;

  // Summary pill row
  const cantBend=m.scsBendable===false;
  const bendBadge=cantBend?'<span style="color:var(--bad);font-weight:700">⚠ NOT BENDABLE (use 5052)</span>':'<span style="color:var(--ok)">✓ SCS Bendable</span>';
  outSum.innerHTML=`<span class="pill" style="border-color:var(--accent)">${m.name}</span> `+
    (m.tags||[]).map(t=>`<span class="pill">${t}</span>`).join(' ')+
    `\n\n${m.summary}\n\n${bendBadge}  |  SCS range: ${m.scsThicknessRange}`;

  // Detail blocks
  const blocks=[];
  if(m.commonGauges?.length) blocks.push(`Common gauges:\n  ${m.commonGauges.join('  |  ')}`);
  if(m.bendingNotes?.length) blocks.push(`Bending:\n• ${m.bendingNotes.join('\n• ')}`);
  if(m.fabricationTips?.length) blocks.push(`Fab tips:\n• ${m.fabricationTips.join('\n• ')}`);
  if(m.weldingNotes?.length) blocks.push(`Welding:\n• ${m.weldingNotes.join('\n• ')}`);
  if(m.finishOptions?.length) blocks.push(`Finish options: ${m.finishOptions.join(' · ')}`);
  if(m.scsLink) blocks.push(`SCS material page → ${m.scsLink}`);
  outDet.textContent=blocks.join('\n\n');
  outWrap.style.display='';
}

// ── Design rules ─────────────────────────────────────────────────────
function smShowRules(){
  const catKey=document.getElementById('smRuleSel').value;
  const out=document.getElementById('smRuleOut');
  const SM=DB.sheetMetal;
  if(!SM?.designRules){out.innerHTML='<span class="warn">Load DB first.</span>';out.style.display='';return;}
  const cat=SM.designRules[catKey];
  if(!cat){out.innerHTML='<span class="warn">Category not found.</span>';out.style.display='';return;}

  let html=`<div style="margin-bottom:8px;font-weight:600;color:var(--accent);font-family:Montserrat,sans-serif;font-size:12px;letter-spacing:.06em;text-transform:uppercase">${cat.title}</div>`;
  if(cat.note) html+=`<div class="small" style="margin-bottom:8px;color:var(--muted)">${cat.note}</div>`;

  html+=`<table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead><tr>
      <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--line);color:var(--muted);width:35%">Rule</th>
      <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--line);color:var(--muted);width:25%">Value</th>
      <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--line);color:var(--muted)">Note</th>
    </tr></thead><tbody>`;

  (cat.rules||[]).forEach(r=>{
    // flangeMinimums has different shape
    const label=r.label||r.gauge||'';
    const val=r.value||r.minFlange||'';
    const note=r.note||'';
    html+=`<tr style="border-bottom:1px solid rgba(31,43,56,0.5)">
      <td style="padding:5px 8px;color:var(--ink);font-weight:500">${label}</td>
      <td style="padding:5px 8px;color:var(--accent);font-family:var(--mono)">${val}</td>
      <td style="padding:5px 8px;color:var(--muted);font-size:11px">${note}</td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  out.innerHTML=html;
  out.style.display='';
}

// ── Tips browser ──────────────────────────────────────────────────────
function smPopulateTips(){
  const sel=document.getElementById('smTipSel');
  // Keep placeholder, wipe the rest
  while(sel.options.length>1)sel.remove(1);
  const SM=DB.sheetMetal;
  if(!SM?.fabricationTipsGeneral)return;
  SM.fabricationTipsGeneral.forEach((t,i)=>{
    const o=document.createElement('option');
    o.value=i;o.textContent=t.category;sel.appendChild(o);
  });
}

function smShowTip(){
  const idx=document.getElementById('smTipSel').value;
  const out=document.getElementById('smTipOut');
  const SM=DB.sheetMetal;
  if(idx===''||!SM){out.style.display='none';return;}
  const t=SM.fabricationTipsGeneral[parseInt(idx)];
  if(!t){out.style.display='none';return;}
  out.textContent=`${t.category}\n\n${t.tip}`;
  out.style.display='';
}

function smShowAllTips(){
  const out=document.getElementById('smTipAllOut');
  const SM=DB.sheetMetal;
  if(!SM?.fabricationTipsGeneral){out.innerHTML='<span class="warn">Load DB first.</span>';out.style.display='';return;}
  const toggled=out.style.display==='none'||out.style.display==='';
  if(!toggled){out.style.display='none';document.getElementById('smTipAll').textContent='Show all tips';return;}
  const chunks=SM.fabricationTipsGeneral.map(t=>
    `<div style="margin-bottom:12px"><div style="color:var(--accent);font-weight:600;font-size:12px;margin-bottom:4px">${t.category}</div><div style="color:var(--ink);font-size:13px">${t.tip}</div></div>`
  ).join('<div style="height:1px;background:var(--line);margin:10px 0"></div>');
  out.innerHTML=chunks;
  out.style.display='';
  document.getElementById('smTipAll').textContent='Hide tips';
}

// ── Boot / wiring for sheet metal tab ───────────────────────────────
function smBoot(){
  const SM=DB.sheetMetal;
  if(!SM)return;
  smRefreshGaugeTable();
  smPopulateMatRef();
  smPopulateTips();
}

document.getElementById('smGaugeLook').onclick=smGaugeLookup;
document.getElementById('smGaugeIn').addEventListener('keydown',e=>{if(e.key==='Enter')smGaugeLookup();});
document.getElementById('smMatSel').addEventListener('change',smRefreshGaugeTable);
document.getElementById('smBendLook').onclick=smBendLookup;
document.getElementById('smBendThick').addEventListener('keydown',e=>{if(e.key==='Enter')smBendLookup();});
document.getElementById('smBdCalc').onclick=smBdCalc;
document.getElementById('smMatRefGo').onclick=smShowMatRef;
document.getElementById('smRuleGo').onclick=smShowRules;
document.getElementById('smTipSel').addEventListener('change',smShowTip);
document.getElementById('smTipAll').onclick=smShowAllTips;

// Re-run smBoot whenever DB is loaded
const _origIngestDB=ingestDB;
// Patch ingestDB to also run smBoot after load
// (we call it directly after the existing boot too)
const smOrigBoot=(function(){
  // On page boot if DB already cached
  const origFn=window.onload;
  return function(){ smBoot(); };
})();


/* ══════════════════════════════════════════════════════════════════════
   INSERT CALCULATOR — PEM & Heat-Set
══════════════════════════════════════════════════════════════════════ */

// ── Sub-tab switching ─────────────────────────────────────────────────
function insSetTab(which){
  document.getElementById('insPemPanel').style.display = which==='pem' ? '' : 'none';
  document.getElementById('insHsPanel').style.display  = which==='hs'  ? '' : 'none';
  document.getElementById('insTabPem').classList.toggle('ins-tab-active', which==='pem');
  document.getElementById('insTabHs').classList.toggle('ins-tab-active',  which==='hs');
}
document.getElementById('insTabPem').onclick = ()=>insSetTab('pem');
document.getElementById('insTabHs').onclick  = ()=>insSetTab('hs');

// ── Populate PEM size dropdown ────────────────────────────────────────
function pemPopulateSizes(){
  const PEM = DB.pemHardware;
  const type = document.getElementById('pemType').value;
  const sel  = document.getElementById('pemSize');
  sel.innerHTML = '';
  if(!PEM){ sel.innerHTML='<option>Load DB first</option>'; return; }
  const rows = PEM[type] || [];
  // dedupe sizes
  const seen = new Set();
  rows.forEach(r=>{
    if(seen.has(r.size)) return; seen.add(r.size);
    const o = document.createElement('option');
    o.value = r.size; o.textContent = r.size;
    sel.appendChild(o);
  });
  // Show general notes once
  const notesEl = document.getElementById('pemNotes');
  notesEl.textContent = (PEM.generalNotes||[]).map((n,i)=>`${i+1}. ${n}`).join('\n');
}

function pemCalc(){
  const PEM  = DB.pemHardware;
  const out  = document.getElementById('pemOut');
  out.style.display='none';
  if(!PEM){ out.textContent='Load shopdb.json first.'; out.style.display=''; return; }
  const type = document.getElementById('pemType').value;
  const size = document.getElementById('pemSize').value;
  const rows = (PEM[type]||[]).filter(r=>r.size===size);
  if(!rows.length){ out.textContent=`No data for ${size}.`; out.style.display=''; return; }
  const r = rows[0];

  const isMetric = !!r.holeMm;
  const holePrimary   = isMetric ? `${r.holeMm.toFixed(1)} mm` : `${r.holeIn.toFixed(3)}"`;
  const holeSecondary = isMetric
    ? `(${(r.holeMm/25.4).toFixed(4)}")`
    : `(${(r.holeIn*25.4).toFixed(2)} mm)`;
  const minThk = isMetric
    ? `${r.minThkMm.toFixed(1)} mm min sheet thickness`
    : `${r.minThkIn.toFixed(3)}" min sheet thickness`;

  const typeLabel = type==='nuts' ? 'Self-Clinching Nut' : 'Flush Stud';
  const lines = [
    `${typeLabel}  —  ${r.size}  [${r.series} series]`,
    `Panel hole: ${holePrimary}  ${holeSecondary}`,
    minThk,
    r.note ? `Note: ${r.note}` : null,
  ].filter(Boolean);
  out.textContent = lines.join('\n');
  out.style.display='';
}

// ── Populate Heat-Set size dropdown ──────────────────────────────────
function hsInsPopulateSizes(){
  const HS  = DB.heatSetInserts;
  const sel = document.getElementById('hsInsSize');
  sel.innerHTML='';
  if(!HS){ sel.innerHTML='<option>Load DB first</option>'; return; }
  (HS.inserts||[]).forEach(r=>{
    const o=document.createElement('option');
    o.value=r.size; o.textContent=r.size;
    sel.appendChild(o);
  });
  // General notes
  const notesEl = document.getElementById('hsInsNotes');
  notesEl.textContent = (HS.generalNotes||[]).map((n,i)=>`${i+1}. ${n}`).join('\n');
}

function hsInsCalc(){
  const HS  = DB.heatSetInserts;
  const out = document.getElementById('hsInsOut');
  out.style.display='none';
  if(!HS){ out.textContent='Load shopdb.json first.'; out.style.display=''; return; }
  const size = document.getElementById('hsInsSize').value;
  const mat  = document.getElementById('hsInsMat').value;
  const row  = (HS.inserts||[]).find(r=>r.size===size);
  if(!row){ out.textContent=`No data for ${size}.`; out.style.display=''; return; }

  const hPrint = row.holeForPrintMm;
  const hDrill = row.holeForDrillMm;
  const outer  = row.outerMm;
  const matNote = (HS.materialNotes||{})[mat] || '';

  const nearDrill = nearestUsDrill(hPrint/25.4);

  const lines = [
    `Heat-Set Insert  —  ${size}`,
    `Insert OD       : ${outer.toFixed(1)} mm`,
    ``,
    `── Printed hole ────────────────`,
    `  Recommended   : ${hPrint.toFixed(1)} mm  (${(hPrint/25.4).toFixed(4)}")` +
      (nearDrill ? `  ≈ drill ${nearDrill.label}` : ''),
    ``,
    `── Drilled/reamed hole ─────────`,
    `  Recommended   : ${hDrill.toFixed(1)} mm  (${(hDrill/25.4).toFixed(4)}")` +
      (nearDrill ? `  ≈ drill ${nearDrill.label}` : ''),
    ``,
    `── Material: ${mat} ─────────────`,
    matNote,
    row.note ? `\nNote: ${row.note}` : null,
  ].filter(v=>v!==null);
  out.textContent = lines.join('\n');
  out.style.display='';
}

// ── Wire up ───────────────────────────────────────────────────────────
document.getElementById('pemType').addEventListener('change', pemPopulateSizes);
document.getElementById('pemCalc').onclick = pemCalc;
document.getElementById('hsInsCalc').onclick = hsInsCalc;

// ── Boot ──────────────────────────────────────────────────────────────
function insBoot(){
  pemPopulateSizes();
  hsInsPopulateSizes();
}



/* ══════════════════════════════════════════════════════════════════════
   FDM 3D PRINT FITS & DESIGN
══════════════════════════════════════════════════════════════════════ */

let fdmSelectedFit = null;

// ── Fit Calculator ───────────────────────────────────────────────────
function fdmBuildFitCards(){
  const grid = document.getElementById('fdmFitGrid');
  grid.innerHTML = '';
  const FDM = DB.fdm3dp;
  if(!FDM){ grid.innerHTML='<div class="small" style="color:var(--muted)">Load DB first.</div>'; return; }
  const ft = FDM.fitTable;
  const order = ['loose','sliding','close','transition','press','hardPress','snapFit','bearingBore'];
  order.forEach(key=>{
    const f = ft[key]; if(!f) return;
    const card = document.createElement('div');
    card.className = 'fdm-fit-card';
    card.dataset.fitKey = key;
    // Compute current clearance for whatever nominal is in the input
    const rawDia = parseFloat(document.getElementById('fdmDia').value) || 10;
    const units  = document.getElementById('fdmUnits').value;
    const diaMm  = units === 'in' ? rawDia * 25.4 : rawDia;
    const cl     = f.baseMm + diaMm * (f.scalePct / 100);
    const sign   = cl >= 0 ? '+' : '';
    const clDisp = units === 'in' ? `${sign}${(cl/25.4).toFixed(4)}"` : `${sign}${cl.toFixed(3)} mm`;
    card.innerHTML = `
      <div class="ffc-label">${f.label}</div>
      <div class="ffc-val">${clDisp} / side</div>
      <div class="ffc-use">${f.use}</div>`;
    card.addEventListener('click', ()=>{ fdmSelectFit(key, card); });
    grid.appendChild(card);
  });
  // Re-apply selected highlight if a fit was already chosen
  if(fdmSelectedFit){
    const sel = document.querySelector(`.fdm-fit-card[data-fit-key="${fdmSelectedFit}"]`);
    if(sel) sel.classList.add('selected');
  }
}

function fdmSelectFit(key, cardEl){
  fdmSelectedFit = key;
  document.querySelectorAll('.fdm-fit-card').forEach(c=>c.classList.remove('selected'));
  cardEl.classList.add('selected');
  fdmComputeFit();
}

function fdmComputeFit(){
  const FDM = DB.fdm3dp; if(!FDM || !fdmSelectedFit) return;
  const rawDia = parseFloat(document.getElementById('fdmDia').value);
  const units  = document.getElementById('fdmUnits').value;
  const res    = document.getElementById('fdmCalcResult');
  if(isNaN(rawDia) || rawDia<=0){ res.style.display='none'; return; }

  const dia = units==='in' ? rawDia*25.4 : rawDia; // work in mm internally
  const f   = FDM.fitTable[fdmSelectedFit];

  // Scaled formula: clearance/side = baseMm + nominal × scalePct/100
  // Press fits stay flat — interference already fights the ±0.2mm machine floor
  const cl = f.baseMm + dia * (f.scalePct / 100);

  const shaftMm = dia;
  const boreMm  = dia + 2 * cl;

  const fmt = (v) => units==='in'
    ? `${(v/25.4).toFixed(4)}"` : `${v.toFixed(2)} mm`;

  // Formula display — always show in user's chosen units for readability
  const clDisplay   = units==='in' ? cl/25.4 : cl;
  const diaDisplay  = rawDia;
  const baseDisplay = units==='in' ? f.baseMm/25.4 : f.baseMm;
  const clUnit      = units==='in' ? 'in' : 'mm';
  const formulaStr  = f.scalePct > 0
    ? `formula: ${baseDisplay>=0?'+':''}${baseDisplay.toFixed(4)} + ${f.scalePct.toFixed(2)}%×${diaDisplay} ${units} = ${clDisplay>=0?'+':''}${clDisplay.toFixed(4)} ${clUnit}/side`
    : `formula: ${baseDisplay.toFixed(4)} ${clUnit} flat (press fits don't scale with size)`;

  const diaStr = `${cl>=0?'+':''}${units==='in' ? (2*cl/25.4).toFixed(4)+'"' : (2*cl).toFixed(3)+' mm'} diametral`;

  document.getElementById('fdmResLabel').textContent       = `${f.label}  •  Ø${rawDia} ${units} nominal`;
  document.getElementById('fdmResShaft').textContent       = fmt(shaftMm);
  document.getElementById('fdmResShaftSub').textContent    = 'model at nominal';
  document.getElementById('fdmResBore').textContent        = fmt(boreMm);
  document.getElementById('fdmResboreSub').textContent     = diaStr;
  document.getElementById('fdmResUse').textContent         = f.use;
  document.getElementById('fdmResFormula').textContent     = formulaStr;

  const warn = document.getElementById('fdmResWarn');
  if(fdmSelectedFit==='hardPress'){
    warn.textContent = '⚠ Hard press fits risk cracking FDM parts. Pilot test on scrap before full part.';
  } else if(fdmSelectedFit==='bearingBore'){
    warn.textContent = '⚠ Bearing bores: print undersize, ream to exact spec. Verify with calipers.';
  } else if(fdmSelectedFit==='press'){
    warn.textContent = '⚠ Test press fit on a small token first — every printer and filament varies.';
  } else {
    warn.textContent = '';
  }

  res.style.display = '';
}

// Re-calc when inputs change
document.getElementById('fdmDia').addEventListener('input', ()=>{ fdmBuildFitCards(); fdmComputeFit(); });
document.getElementById('fdmUnits').addEventListener('change', ()=>{ fdmBuildFitCards(); fdmComputeFit(); });

// ── Design Rules Accordion ───────────────────────────────────────────
function fdmBuildRules(){
  const acc = document.getElementById('fdmRulesAccordion');
  acc.innerHTML = '';
  const FDM = DB.fdm3dp; if(!FDM) return;
  (FDM.designRules||[]).forEach(rule=>{
    const div = document.createElement('div');
    div.className = 'fdm-rule';

    const valsHtml = Object.entries(rule.values||{}).map(([k,v])=>
      `<dt>${k}</dt><dd>${v}</dd>`).join('');

    const tipsHtml = (rule.tips||[]).map((t,i)=>
      `<div style="font-size:12px;padding:3px 0;display:flex;gap:8px">
        <span style="color:var(--accent);min-width:14px">${i+1}.</span>
        <span style="color:#dbe3ec">${t}</span>
       </div>`).join('');

    div.innerHTML = `
      <div class="fdm-rule-hdr" onclick="fdmToggleRule(this)">
        <span class="fdm-rule-icon">${rule.icon}</span>
        <span class="fdm-rule-title">${rule.title}</span>
        <span class="fdm-rule-chevron">▶</span>
      </div>
      <div class="fdm-rule-body">
        <dl class="fdm-rule-vals" style="margin-top:10px">${valsHtml}</dl>
        <div class="separator"></div>
        ${tipsHtml}
      </div>`;
    acc.appendChild(div);
  });
}

function fdmToggleRule(hdr){
  const body    = hdr.nextElementSibling;
  const chevron = hdr.querySelector('.fdm-rule-chevron');
  const isOpen  = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  chevron.style.transform = isOpen ? '' : 'rotate(90deg)';
}

// ── Material Quick Reference Table ───────────────────────────────────
function fdmBuildMatTable(){
  const el = document.getElementById('fdmMatTable');
  const FDM = DB.fdm3dp; if(!FDM){ el.innerHTML=''; return; }
  const mats = FDM.materialQuickRef;

  const warpBadge = v => {
    if(v.includes('Low'))  return `<span class="badge badge-ok">${v}</span>`;
    if(v.includes('High')) return `<span class="badge badge-bad">${v}</span>`;
    return `<span class="badge badge-warn">${v}</span>`;
  };
  const fatigueBadge = v => {
    if(v==='Excellent'||v==='Very Good') return `<span class="badge badge-ok">${v}</span>`;
    if(v==='Poor')                        return `<span class="badge badge-bad">${v}</span>`;
    return `<span class="badge badge-warn">${v}</span>`;
  };

  const rows = Object.entries(mats).map(([mat,m])=>`
    <tr>
      <td><span class="fdm-mat-name">${mat}</span></td>
      <td>${warpBadge(m.warp)}</td>
      <td>${fatigueBadge(m.flexFatigue)}</td>
      <td style="color:var(--muted)">${m.heatRes}</td>
      <td style="color:var(--muted)">${m.notes}</td>
    </tr>`).join('');

  el.innerHTML = `<table class="fdm-mat-table">
    <thead><tr>
      <th>Material</th><th>Warp</th><th>Flex/Fatigue</th><th>Heat Res</th><th>Notes</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

// ── Shop Tips Library ────────────────────────────────────────────────
let fdmActiveCat = 'All';

function fdmBuildTips(filterCat){
  const FDM = DB.fdm3dp; if(!FDM) return;
  const tips   = FDM.shopTips||[];
  const listEl = document.getElementById('fdmTipList');

  const filtered = filterCat==='All' ? tips : tips.filter(t=>t.cat===filterCat);
  listEl.innerHTML = filtered.map(t=>`
    <li>
      <span class="fdm-tip-cat">${t.cat}</span>
      <span>${t.tip}</span>
    </li>`).join('');
}

function fdmBuildTipFilters(){
  const FDM = DB.fdm3dp; if(!FDM) return;
  const cats = ['All', ...new Set((FDM.shopTips||[]).map(t=>t.cat))];
  const el   = document.getElementById('fdmTipFilter');
  el.innerHTML = cats.map(c=>`
    <button class="${c===fdmActiveCat?'active':''}" onclick="fdmFilterTips('${c}')">${c}</button>`
  ).join('');
}

function fdmFilterTips(cat){
  fdmActiveCat = cat;
  fdmBuildTipFilters();
  fdmBuildTips(cat);
}

// ── Boot ─────────────────────────────────────────────────────────────
function fdmBoot(){
  const FDM = DB.fdm3dp;
  if(!FDM){
    document.getElementById('fdmFitGrid').innerHTML = '<div class="small" style="color:var(--muted)">Load shopdb.json to begin.</div>';
    return;
  }
  fdmBuildFitCards();
  fdmBuildRules();
  fdmBuildMatTable();
  fdmBuildTipFilters();
  fdmBuildTips('All');
  // Auto-select "sliding" as a sensible default so the calculator is live immediately
  const defaultCard = document.querySelector('.fdm-fit-card[data-fit-key="sliding"]');
  if(defaultCard) fdmSelectFit('sliding', defaultCard);
}

setTimeout(fdmBoot, 250);

/* ══════════════════════════════════════════════════════════════════════
   CNC ROUTER — FEEDS & SPEEDS
══════════════════════════════════════════════════════════════════════ */

// sfmCategory in materials → cncRouter category key mapping
const CNC_CAT_MAP = {
  aluminum:   'aluminum',
  steel:      'steel',
  stainless:  'steel',      // rare on router — use steel params as conservative baseline
  composite:  'composite',
  wood:       'wood',
  wood_dense: 'wood_dense',
  plastic:    'plastic',
  foam:       'foam_core',
};

function cncGetCats(){
  const CNC = DB.cncRouter;
  if(!CNC) return {};
  return CNC.categories || {};
}

// Populate material dropdown from DB materials + cncRouter categories
function cncPopulateMat(){
  const sel = document.getElementById('cncMat');
  sel.innerHTML = '';
  const cats = cncGetCats();
  if(!Object.keys(cats).length){
    sel.innerHTML='<option value="">Load DB first</option>';
    document.getElementById('cncBitGuide').textContent='Load shopdb.json to begin.';
    return;
  }
  // Build options in a sensible order
  const order = ['aluminum','composite','wood','wood_dense','plastic','foam_core','steel'];
  order.forEach(key=>{
    const cat = cats[key];
    if(!cat) return;
    const o = document.createElement('option');
    o.value = key;
    o.textContent = cat.label;
    sel.appendChild(o);
  });
  cncPopulateBit();
  cncUpdateBitGuide();
}

// Populate bit dropdown for selected material
function cncPopulateBit(){
  const sel  = document.getElementById('cncBit');
  const matK = document.getElementById('cncMat').value;
  sel.innerHTML = '';
  const cats = cncGetCats();
  const cat  = cats[matK];
  if(!cat){ return; }
  (cat.bitTypes||[]).forEach(bt=>{
    const o = document.createElement('option');
    o.value = bt.id;
    o.textContent = bt.label + (bt.recommended ? ' ★' : '');
    sel.appendChild(o);
  });
}

// Update the bit guide panel when material changes
function cncUpdateBitGuide(){
  const matK = document.getElementById('cncMat').value;
  const cats = cncGetCats();
  const cat  = cats[matK];
  const el   = document.getElementById('cncBitGuide');
  if(!cat){ el.textContent='Select a material.'; el.style.color=''; return; }

  const lines = (cat.bitTypes||[]).map(bt=>{
    const cl = cat.chiploads[bt.id];
    const rec = bt.recommended ? ' ★ Recommended' : '';
    return `${bt.label}${rec}\n  Flutes: ${bt.flutes}  |  Chipload: ${cl.lo}–${cl.hi} ${cl.unit}`;
  });
  el.style.color = 'var(--ink)';
  el.style.whiteSpace = 'pre-wrap';
  el.style.fontSize = '12px';
  el.textContent = lines.join('\n\n');
}

// Main calculator
function cncCalc(){
  const matK    = document.getElementById('cncMat').value;
  const bitId   = document.getElementById('cncBit').value;
  const diaRaw  = parseFloat(document.getElementById('cncDia').value);
  const diaUnit = document.getElementById('cncDiaUnits').value;
  const rpm     = parseFloat(document.getElementById('cncRpm').value);
  const bias    = document.getElementById('cncBias').value;
  const cutType = document.getElementById('cncCutType').value;
  const thkRaw  = parseFloat(document.getElementById('cncThk').value);

  const outEl   = document.getElementById('cncOut');
  const emptyEl = document.getElementById('cncOutEmpty');

  const cats = cncGetCats();
  const cat  = cats[matK];

  if(!cat || isNaN(diaRaw) || isNaN(rpm) || diaRaw<=0 || rpm<=0){
    outEl.style.display='none'; emptyEl.style.display='';
    emptyEl.textContent='Check inputs — something is missing or zero.';
    return;
  }

  const bitDef = (cat.bitTypes||[]).find(b=>b.id===bitId);
  if(!bitDef){ outEl.style.display='none'; emptyEl.style.display=''; return; }

  const diaIn = diaUnit==='mm' ? diaRaw/25.4 : diaRaw;
  const thkIn = diaUnit==='mm' ? thkRaw/25.4 : thkRaw;
  const flutes = bitDef.flutes;

  const cl = cat.chiploads[bitId];
  // Pick chipload based on bias
  let chipload;
  if(bias==='lo')  chipload = cl.lo;
  else if(bias==='hi') chipload = cl.hi;
  else chipload = (cl.lo + cl.hi) / 2;

  // Feedrate (IPM) = RPM × flutes × chipload
  const feedIPM = rpm * flutes * chipload;

  // Plunge
  const plungeIPM = feedIPM * cat.plungeRatePct;

  // DOC
  const docPct = cat.doc.pct;
  const docIn  = diaIn * docPct;

  // Number of passes
  const passes = thkIn > 0 ? Math.ceil(thkIn / docIn) : '—';

  // Stepover
  const soPct  = cutType==='finish' ? cat.stepover.finishPct : cat.stepover.roughPct;
  const soIn   = diaIn * soPct;

  // Actual SFM achieved
  const sfm = Math.round((rpm * Math.PI * diaIn) / 12);
  const [sfmLo, sfmHi] = cat.sfmRange;
  const sfmOk = sfm >= sfmLo && sfm <= sfmHi;
  const sfmWarn = sfm < sfmLo*0.8 || sfm > sfmHi*1.2;

  // Format helpers
  const fmtIn = (v,dp=3) => v.toFixed(dp)+'"';
  const fmtMm = (v) => (v*25.4).toFixed(2)+' mm';
  const dual  = (v) => `${fmtIn(v)} / ${fmtMm(v)}`;

  // Fill stat cards
  document.getElementById('cncResChipload').textContent = chipload.toFixed(4)+'"';
  document.getElementById('cncResChiploadsub').textContent = `${cl.lo}–${cl.hi} in/tooth range`;
  document.getElementById('cncResFeed').textContent = Math.round(feedIPM);
  document.getElementById('cncResPlunge').textContent = Math.round(plungeIPM);
  document.getElementById('cncResDoc').textContent = fmtIn(docIn,3);
  document.getElementById('cncResDocsub').textContent = `${Math.round(docPct*100)}% dia · ${passes} pass${passes!==1?'es':''} thru`;
  document.getElementById('cncResSo').textContent = fmtIn(soIn,3);
  document.getElementById('cncResSosub').textContent = `${Math.round(soPct*100)}% dia · ${fmtMm(soIn)}`;

  const sfmColor = sfmWarn ? 'var(--bad)' : sfmOk ? 'var(--ok)' : 'var(--warn)';
  document.getElementById('cncResSfm').textContent = sfm;
  document.getElementById('cncResSfm').style.color = sfmColor;
  document.getElementById('cncResSfmsub').textContent = `target ${sfmLo}–${sfmHi} SFM`;

  // Summary block
  const summaryLines = [
    `Bit: ${bitDef.label} (${flutes}fl)  |  ${diaUnit==='mm' ? diaRaw.toFixed(2)+' mm' : diaRaw+'"'} dia`,
    `RPM: ${rpm.toLocaleString()}  |  Feed: ${Math.round(feedIPM)} IPM  |  Plunge: ${Math.round(plungeIPM)} IPM`,
    `DOC: ${dual(docIn)}  |  Stepover: ${dual(soIn)}`,
    `SFM: ${sfm}  (target ${sfmLo}–${sfmHi})${sfmWarn?' ⚠ OUT OF RANGE':sfmOk?' ✓':' ≈ borderline'}`,
    `Bias: ${bias}  |  Cut: ${cutType}`,
  ];
  document.getElementById('cncResSummary').textContent = summaryLines.join('\n');

  // Notes panel
  const notesEl    = document.getElementById('cncNotesMat');
  const notesEmpty  = document.getElementById('cncNotesEmpty');
  const notesLabel  = document.getElementById('cncNotesMatLabel');
  const notesBody   = document.getElementById('cncNotesMatBody');
  const notesLube   = document.getElementById('cncNotesLube');
  const notesClimb  = document.getElementById('cncNotesClimb');

  notesLabel.textContent = cat.label;
  notesBody.textContent  = (cat.notes||[]).map((n,i)=>`${i+1}. ${n}`).join('\n');
  notesLube.textContent  = cat.lube;
  notesClimb.textContent = cat.climbFirst
    ? 'Climb cut recommended — reduces cutting force and improves finish.'
    : 'Conventional cut for roughing; climb cut for finish pass.';
  notesEl.style.display  = '';
  notesEmpty.style.display = 'none';

  outEl.style.display  = '';
  emptyEl.style.display = 'none';
}

// Wire up
document.getElementById('cncMat').addEventListener('change', ()=>{ cncPopulateBit(); cncUpdateBitGuide(); });
document.getElementById('cncCalc').onclick = cncCalc;
document.getElementById('cncDia').addEventListener('keydown', e=>{ if(e.key==='Enter') cncCalc(); });

function cncBoot(){
  cncPopulateMat();
}

setTimeout(cncBoot, 200);

</script>
</body>
</html>
